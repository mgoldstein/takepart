<?php

/**
 * @file
 * View template to render view fields as XML.
 *
 * - $view: The view in use.
 * - $rows: Array of row objects as rendered by _views_json_render_fields
 * - $attachment: not used currently
 * - $options: The options for the style passed in from the UI.
 *
 * @ingroup views_templates
 * @see views_xml.views.inc
 */

/**
 * Template preprocess for RSS w/ Images
 * @param $vars
 * @return unknown_type
 *
 *   $options = parent::option_definition();
  $options['schema'] = array('default' => 'raw', 'translatable' => FALSE);
  $options['escape_as_CDATA'] = array('default' => 'no', 'translatable' => FALSE);
  $options['content_type'] = array('default' => 'text/xml', 'translatable' => FALSE);
  $options['header'] = array('
 *
 */
function template_preprocess_views_views_takepart_rss_style_rssimages(&$vars) {

    $rows = $vars["rows"];
    $options = $vars["options"];
    // use the dublin core style:
    // $xml .= "<rss version=\"2.0\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:wfw=\"http://wellformedweb.org/CommentAPI/\">\n";

    $xml = "<?xml version=\"1.0\" encoding=\"utf-8\"?" . ">\n";

    $u_agent = $_SERVER['HTTP_USER_AGENT'];

    /* Styles for browsers without their own RSS themes:
      if(preg_match('/Chrome/i',$u_agent)) {
      $xml .= "<?xml-stylesheet href=\"" . "/" . (drupal_get_path('module', 'views_takepart_rss') . '/rss.xsl') . "\" type=\"text/xsl\" media=\"screen\"?". ">";
      } elseif(preg_match('/Safari/i',$u_agent)) {
      $xml .= "<?xml-stylesheet href=\"" . "/" . (drupal_get_path('module', 'views_takepart_rss') . '/rss.xsl') . "\" type=\"text/xsl\" media=\"screen\"?". ">";
      } */

    $xml .= "<rss version=\"2.0\"";
    $xml .= "  xmlns:dc=\"http://purl.org/dc/elements/1.1/\"";
    $xml .= "  xmlns:content=\"http://purl.org/rss/1.0/modules/content/\"";
    $xml .= "  xmlns:admin=\"http://webns.net/mvcb/\"";
    $xml .= "  xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\">";

    $xml .= "\t<channel>\n";
    $table_queue = ($vars['view']->query->table_queue);
    // Titles will change depending on the type of content selected:
    // print "----------------";
    // print_r($table_queue);
    foreach ($table_queue as $titles) {
        if ($titles['alias'] == 'node') {
            // @todo: what should the title / desc be if the view is being joined to a node?
            // $node = node_load($termid);
            // $title .= $node->title;
        }
        if (substr($titles['alias'], 0, 16) == 'field_data_field') {
            // if we're joining against taxonomy, pull the title out:
            $fieldname = substr($titles['alias'], 17, strlen($titles['alias']));
            // @todo: null check this:
            $termid = $vars['view']->args[0];
            // find titles based on the parent field and id argument when the arg is taxonomy:
            $terms = _takepart_rss_get_taxonomy_title($fieldname, $termid);
            
            foreach ($terms as $term) {
                $title .= $term->name;
                $description .= $term->description;
            }
        }
    }

    // @todo: add check for $options['escape_as_CDATA'] == 'yes')
    if ($options['title']) {
        $xml .= "\t<title><![CDATA[" . $options['title'] . $title . "]]></title>\n";
    } else {
        $xml .= "\t<title><![CDATA[" . $title . "]]></title>\n";
    }
    $xml .= "\t<link>" . _takepart_rss_selfURL() . "</link>\n";
    $xml .= "\t<description><![CDATA[" . $description . "]]></description>\n";

    foreach ($rows as $row) {
        $xml .= "\t\t<item>\n";
        $description = '';
        $content = '';
        foreach ($row as $id => $object) {
            // print_r($object);
            // print "$id-------------------------";
            if ($id == 'created') {
                $xml .= "\t\t\t<pubDate><![CDATA[" . $object->content . "]]></pubDate>\n";
            } else if ($id == 'title') {
                $xml .= "\t\t\t<title><![CDATA[" . $object->raw . "]]></title>\n";
                $poslink = _takepart_rss_parseHref($object->content);
                if ($poslink) {
                    $xml .= "\t\t\t<link><![CDATA[" . $poslink . "]]></link>\n";
                }
            } else if ($id == 'field_display_tag' && $object->content != '') {
                $xml .= "\t\t\t<category><![CDATA[" . $object->content . "]]></category>\n";
            } else if ($id == 'field_promo_text' && $object->content != '') {
                $xml .= "\t\t\t<description><![CDATA[" . $object->content . "]]></description>\n";
            } else {
                $content .= ($object->content);
            }
        }
        $protocol = _takepart_rss_strleft(strtolower($_SERVER["SERVER_PROTOCOL"]), "/").$s;
        $port = ($_SERVER["SERVER_PORT"] == "80") ? "" : (":".$_SERVER["SERVER_PORT"]);
        $urlprefix = $protocol."://".$_SERVER['SERVER_NAME'].$port;
        $content=preg_replace('#(href|src)="([^:"]*)(?:")#', '$1=$urlprefix."/$2"', $content);
        $xml .= "\t\t\t<content:encoded><![CDATA[" . $content . "]]></content:encoded>\n";
        $xml .= "\t\t</item>\n";
    }
    $xml .= "\t</channel>\n";
    $xml .= "</rss>";
    $vars["xml"] = $xml;
}
