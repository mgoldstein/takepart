<?php

class BSDSignupLimitTestCase extends DrupalUnitTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Signup limit',
      'description' => 'Test that Blue State Digital signup limits work properly through the API',
      'group' => 'TakePart'
    );
  }

  /**
   * Test limiting signup forms
   *
   * This test uses a development signup form created specifically for this
   * test. The form is set to only allow one signup per hour based on email
   * address. This test generates an email address using a timestamp from
   * time(), if it is run more than once per second it will fail.
   */
  function testSignupLimit() {

    // select the test signup form
    $form_id = 22;
    $field_id = 336;

    // make sure the test signup form exists
    $form = takepart_bsd_signup_form($form_id);
    $this->assertFalse($form === FALSE);

    // make sure the test signup field exists
    $fields = takepart_bsd_signup_list_form_fields($form_id);
    $this->assertFalse(empty($fields));
    $this->assertNotNull($fields[$field_id]);

    // build an email using a time stamp to allow the test to be run repeatedly
    $email = sprintf('signup.limit.test.%d@takepart.com', time());

    // populate the signup fields
    $fields[$field_id]['value'] = array(
      'type' => 'value',
      'value' => $email,
    );

    // create the signup
    $signup = array($form_id => $fields);

    // send the signup the first time
    $errors = array();
    $response = takepart_bsd_signup_process_signup($signup, $errors);
    $this->assertTrue($response);
    $this->assertTrue(empty($errors));

    // send the signup the second tme
    $errors = array();
    $response = takepart_bsd_signup_process_signup($signup, $errors);
    $this->assertFalse($response);
    $this->assertTrue(is_array($errors));
    $this->assertTrue(count($errors) === 1);
    $this->assertEqual($errors[0]['description'], 'Email limiting check failed');
  }
}
