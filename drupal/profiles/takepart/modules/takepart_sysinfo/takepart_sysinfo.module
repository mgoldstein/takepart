<?php

/**
 * Implements hook_preprocess().
 */
function takepart_sysinfo_preprocess(&$variables, $hook) {
  if(variable_get('takepart_sysinfo_state', '1') == '1') {
    $comment_tags = "<!-- TPSI";
    $comment_tags .= _takepart_sysinfo_getdata(variable_get('takepart_sysinfo_code', ''));
    $comment_tags .= "\n -->";
    $variables['tp_sysinfo_comment_tags'] = $comment_tags;
  }
}

/**
 * Function to return data.
 */
function _takepart_sysinfo_getdata($code) {
  $str = '';
  $arrcode = explode("\n", $code);
  for ($i = 0; $i < count($arrcode); $i++) {
    try {
      if($arrcode[$i]) { 
        if(strlen(trim($arrcode[$i])) > 0) {
          $continue = true;
          $match = array();
          $code = $arrcode[$i];
          $regex = true;
          $fncst = true;
          //Check for bad functions so we don't break the site:
          do {
            $regex = preg_match('/([\w\_\d]+)\(([\w\W]*)\)/', $code, $match);
            if(is_array($match) && count($match) > 0) {
              $fncst = (function_exists($match[1]));
              $code = $match[2];
            } else {
              $fncst = false;
            }
          } while($fncst);
          //If the parameter is a variable, or a funcion known to exist:
          if($regex == 0 || $fncst) {
            eval("try { \$str .= \"\\n\". $arrcode[$i] } catch(Exception \$e) { drupal_set_message(\$e->getMessage(), 'error'); }");
          } else {
            $str = $str . "\nMethod ". $match[1] . " does not exist!";
          }
        }
      }
     } catch (Exception $e) { }
  }
  return $str;
}



/**
 * Implement hook_help().
 */
function takepart_sysinfo_help($path, $arg) {
  if ($path == 'admin/help#takepart_sysinfo') {
    return t("The Takepart Sysinfo module populates the 
    	tp_sysinfo_comment_tags variable to display html 
    	comment tags with system information in templates.  Configuration is availible in the 
        <a href = \"/admin/config/development\">development</a>
        section. 
		<br /><br />
		For example, you might add:<br />
		date(\"m/d/Y h:i:s a\", time());<br />
		\$_SERVER[\"SERVER_NAME\"];<br />
		\$_SERVER[\"SERVER_PORT\"];<br />
		php_uname();<br />
		And place ... <br />
 		&lt;?php print \$tp_sysinfo_comment_tags; ?&gt;<br />
 		into one of your page templates. <br /><br />");
  }
}


/**
 * Implement hook_menu().
 */
function takepart_sysinfo_menu() {
  $items = array();

  $items['admin/config/development/takepart_sysinfo'] = array(
    'title' => 'TakePart Sysinfo',
    'description' => 'Configuration for the TakePart Sysinfo module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('takepart_sysinfo_form'),
    'access arguments' => array('administer users'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}


/**
 * Admin Form
 */
function takepart_sysinfo_form($form, &$form_state) {
  
  $evaldcode = "";
  
  try {
    $evaldcode = t(_takepart_sysinfo_getdata(variable_get('takepart_sysinfo_code', '')));
  } catch (Exception $e) {
    drupal_set_message($e->getMessage(), 'error');
  }
  
  
  
  $form['takepart_sysinfo_state'] = array(
    '#type' => 'select',
    '#title' => t('Show Comments'),
    '#default_value' => variable_get('takepart_sysinfo_state', 'No'),
    '#options' => array(0 => t('No'), 1 => t('Yes'),),
    '#required' => TRUE,
  );
  $form['takepart_sysinfo_code'] = array(
    '#type' => 'textarea',
    '#rows' => 10,
    '#columns' => 40,
    '#title' => t('Code'),
    '#required' => TRUE,
    '#default_value' => variable_get('takepart_sysinfo_code', ''),
    '#description'=> t('PHP Code to include in the tag.'),
  );
  $form['takepart_sysinfo_markup'] = array(
      '#type' => 'item',
      '#title' => t('Example'),
      '#markup' => '<pre>' . $evaldcode . '</pre>',
  );
  $form['submit'] = array(
  	'#type' => 'submit',
  	'#value' => t('Save settings'),
  );
  return $form;
}

/**
 * Save Configuration:
 */
function takepart_sysinfo_form_submit($form, &$form_state) {
  $newstate = $form_state['values']['takepart_sysinfo_state'];
  $code = $form_state['values']['takepart_sysinfo_code'];
  variable_set('takepart_sysinfo_state', $newstate);
  variable_set('takepart_sysinfo_code', $code);
  drupal_set_message(t('The settings have been saved'));
}