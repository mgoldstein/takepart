<?php

/***
 * implentation of hook_init()
 */
function takepart_vidpop_init() {
  $path = drupal_get_path('module', 'takepart');
  drupal_add_css($path . '/modules/takepart_vidpop/css/takepart_vidpop.css', array('every_page' => TRUE));
  //drupal_add_js($path . '/modules/takepart_vidpop/js/takepart_vidpop.js', 'file');
}


/**
 * Implement hook_theme().
 *
 * This one is used as the base to reduce errors when updating.
 */
function takepart_vidpop_theme() {
  $template_path = drupal_get_path('module', 'takepart') . '/modules/takepart_vidpop/theme';

  return array(
    'node__video_embed' => array(
      'path'      => $template_path,
      'template'  => 'node--video-embed',
      'variables' => array('node' => NULL),
    ),
    'vidpop_popup' => array(
      'path'      => $template_path,
      'template'  => 'vidpop-popup',
      'variables' => array('node' => NULL),
    ),
  );
}


/**
 * Implements hook_menu().
 */
function takepart_vidpop_menu() {
  $items['admin/config/media/vidpop/settings'] = array(
    'title' => 'Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('takepart_vidpop_settings_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'takepart_vidpop.admin.inc',
  );

  return $items;
}


/***
 * format image to look like a youtube video preview
 *
 * @param $uri    uri of image
 * @param $vars   variables from node preprocessing
 *
 * uses image style tp_embed_video_thumb to create a 420x315 image
 *
 */
function takepart_vidpop_format_preview($uri, $vars) {
  $vidpop_path = drupal_get_path('module', 'takepart') . '/modules/takepart_vidpop';
  $preview_image = theme('image_style', array('style_name' => 'tp_embed_video_thumb', 'path' => $uri));
  $overlay_image = theme('image', array('path' => $vidpop_path . '/images/youtube-overlay.png', 'attributes' => array('rel' => 'details')));

  $preview_image = theme('image_style', array('style_name' => 'tp_embed_video_thumb', 'path' => $uri));
  $overlay_image = theme('image', array('path' => $vidpop_path . '/css/images/youtube-overlay.png', 'attributes' => array('rel' => '#details', 'class' => 'vidpop-trigger')));

  // theme the popup contents
  $formatted_popup = theme('vidpop_popup', $vars);

  //$preview_image = 'linkk';
  //$formatted_popup = '<div>woowee</div>';

  $formatted = <<<EOT
<div class="vidpop-preview">$preview_image
  <a class="colorbox-inline" href="?width=900&amp;height=525&amp;inline=true#vidpop-details"><div class="vidpop-preview-overlay">$overlay_image</div></a>
</div>

<div class="vidpop-overlay">
  <div id="vidpop-details">$formatted_popup</div>
</div>
EOT;

  return $formatted;
}


/***
 * @returns formatted banner
 * @param $box_id   id of box (delta, from box table)
 */
function takepart_vidpop_get_banner($box_id) {
  // get the ad box
  $block = block_load('boxes', $box_id);
  $banner =  render(_block_get_renderable_array( _block_render_blocks( array($block) )));

  return $banner;
}

