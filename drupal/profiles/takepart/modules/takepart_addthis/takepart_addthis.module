<?php
/**
 * @file
 * This is the TakePart AddThis Blocks module.
 */
 /**
 * Implement hook_permission().
 */
function takepart_addthis_permission() {
  return array(
    'administer takepart_addthis' => array(
      'title' => 'Administer AddThis sharing widget',
      'description' => 'Change which services are shown, color, etc and add addthis.com username',
    ),
  );
}

/**
 * Implement of hook_menu().
 */
function takepart_addthis_menu() {
  $items = array();

  $items['admin/config/system/takepart-addthis'] = array(
    'title'            => t('AddThis'),
    'description'      => t('Set default settings for <a href="http://www.addthis.com/">AddThis</a> button.'),
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('takepart_addthis_admin_settings'),
    'access arguments' => array('administer takepart_addthis'),
    'file'             => 'takepart_addthis.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_preprocess().
 *
 * Attaches a few key strings to $variables for use by the template, including a 
 * string full of custom buttons and the AddThis public ID.
 */
function takepart_addthis_preprocess(&$variables, $hook) {
  $ADD_THIS_PUB_ID = variable_get('takepart_addthis_pub_id','ra-4e48103302adc2d8');
  drupal_add_js(drupal_get_path('module','takepart_addthis') . '/js/exaddthis.js', 'file');
  drupal_add_js('http://s7.addthis.com/js/250/addthis_widget.js#pubid=' . $ADD_THIS_PUB_ID, 'external');

  $takepart_blogpost_custom_btns =<<<EOS
<a class="addthis_button_stumbleupon">Stumble this</a>
<a class="addthis_button_digg">Digg this</a>
<a class="addthis_button_email">E-mail this</a>
EOS;
/* To add a print friendly button, you need to the following line to the $takepart_blogpost_custom_btns:
<a class="addthis_button_print">Print</a>
*/
  $variables['addthis_custom_buttons']              = $takepart_blogpost_custom_btns;
  $variables['addthis_pubid']                       = $ADD_THIS_PUB_ID;
  $variables['takepart_addthis_tweet_via']          = variable_get('takepart_addthis_tweet_via','');
  $variables['takepart_addthis_facebook_like_text'] = variable_get('takepart_addthis_facebook_like_text','like');
}

function takepart_addthis_views_api() {
  return array(
    'api' => '3.0-alpha1',
  );
}

//hook_block_info() router
function takepart_addthis_block_info(){
  $zeBlocks = array();
  
  takepart_addthis_footer_block_info($zeBlocks);
  takepart_addthis_full_block_info($zeBlocks);
  takepart_addthis_rightrail_block_info($zeBlocks);
  takepart_addthis_simple_block_info($zeBlocks);
  takepart_addthis_petition_block_info($zeBlocks);
  takepart_addthis_ajax_form_block_info($zeBlocks);

  return $zeBlocks;
}

//hook_theme() router
function takepart_addthis_theme(){
  $ret_arr = array();
  
  takepart_addthis_footer_theme($ret_arr);
  takepart_addthis_full_theme($ret_arr);
  takepart_addthis_rightrail_theme($ret_arr);
  takepart_addthis_simple_theme($ret_arr);
  takepart_addthis_petition_theme($ret_arr);
  takepart_addthis_ajax_form_theme($ret_arr);
  return $ret_arr;
}

//hook_block_view() router
function takepart_addthis_block_view($delta = ''){
  $ret_view = array();
  
  switch($delta) {
    case 'addthis_footer':
      $ret_view = takepart_addthis_footer_block_view($delta);
      break;
    case 'addthis_full':
      $ret_view = takepart_addthis_full_block_view($delta);
      break;
    case 'addthis_rightrail':
      $ret_view = takepart_addthis_rightrail_block_view($delta);
      break;
    case 'addthis_simple':
      $ret_view = takepart_addthis_simple_block_view($delta);
      break;
    case 'addthis_petition':
      $ret_view = takepart_addthis_petition_block_view($delta);
      break;
    case 'addthis_ajax_form':
      $ret_view = takepart_addthis_ajax_form_block_view($delta);
      break;
  }
  
  return $ret_view;
}

//hook_block_configure() router
function takepart_addthis_block_configure($delta = ''){
  $ret_form = array();
  
  switch($delta){
    case 'addthis_footer':
      $ret_form = takepart_addthis_footer_block_configure($delta);
      break;
    case 'addthis_full':
      $ret_form = takepart_addthis_full_block_configure($delta);
      break;
    case 'addthis_rightrail':
      $ret_form = takepart_addthis_rightrail_block_configure($delta);
      break;
    case 'addthis_simple':
      $ret_form = takepart_addthis_simple_block_configure($delta);
      break;
    case 'addthis_petition':
      $ret_form = takepart_addthis_petition_block_configure($delta);
      break;
    case 'addthis_ajax_form':
      $ret_form = takepart_addthis_ajax_form_block_configure($delta);
      break;
  }
  
  return $ret_form;
}

//hook_block_save() router
function takepart_addthis_block_save($delta = '', $edits = array()){
  switch($delta){
    case 'addthis_footer':
      takepart_addthis_footer_block_save($delta, $edits);
      break;
    case 'addthis_full':
      takepart_addthis_full_block_save($delta, $edits);
      break;
    case 'addthis_rightrail':
      takepart_addthis_rightrail_block_save($delta, $edits);
      break;
    case 'addthis_simple':
      takepart_addthis_simple_block_save($delta, $edits);
      break;
    case 'addthis_petition':
      takepart_addthis_petition_block_save($delta, $edits);
      break;
    case 'addthis_ajax_form':
      takepart_addthis_ajax_form_block_save($delta, $edits);
      break;
  }
}

/******************
 * AddThis_full section
 */
 
function takepart_addthis_full_block_info(&$blocks){
  $blocks['addthis_full'] = array(
    'info' => t('AddThis - full'),
  );
}

function takepart_addthis_full_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_full_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-full-block',
  );
}

function takepart_addthis_full_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_full'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_full_block', array()
    );

    return $block;
  }
}

function takepart_addthis_full_block_configure($delta){
  $form = array();
    
  if($delta == 'addthis_full'){
  }
  
  return $form;
}

function takepart_addthis_full_block_save($delta, $edits){
  if($delta == 'addthis_full'){
  }
}

/******************
 * AddThis_rightrail section
 */
 
function takepart_addthis_rightrail_block_info(&$blocks){
  $blocks['addthis_rightrail'] = array(
    'info' => t('AddThis - rightrail'),
  );
}

function takepart_addthis_rightrail_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_rightrail_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-rightrail-block',
  );
}

function takepart_addthis_rightrail_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_rightrail'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_rightrail_block', array()
    );

    return $block;
  }
}

function takepart_addthis_rightrail_block_configure($delta){
  $form = array();
    
  if($delta == 'addthis_rightrail'){
  }
  
  return $form;
}

function takepart_addthis_rightrail_block_save($delta, $edits){
  if($delta == 'addthis_rightrail'){
  }
}
 
/******************
 * addthis_footer section
 */

function takepart_addthis_footer_block_info(&$blocks){
  $blocks['addthis_footer'] = array(
    'info' => t('AddThis - footer'),
  );
}

function takepart_addthis_footer_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_footer_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-footer-block',
  );
}

function takepart_addthis_footer_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_footer'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_footer_block', array()
    );

    return $block;
  }
}

function takepart_addthis_footer_block_configure($delta){
  $form = array();
    
  if($delta == 'addthis_footer'){
  }
  
  return $form;
}

function takepart_addthis_footer_block_save($delta, $edits){
  if($delta == 'addthis_footer'){
  }
}

/******************
 * addthis_top section
 */

function takepart_addthis_simple_block_info(&$blocks){
  $blocks['addthis_simple'] = array(
    'info' => t('AddThis - Share FB and Tweet'),
  );
}

function takepart_addthis_simple_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_simple_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-simple-block',
  );
}

function takepart_addthis_simple_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_simple'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_simple_block', array()
    );

    return $block;
  }
}

function takepart_addthis_simple_block_configure($delta){
  $form = array();
    
  if($delta == 'addthis_simple'){
  }
  
  return $form;
}

function takepart_addthis_simple_block_save($delta, $edits){
  if($delta == 'addthis_simple'){
  }
}

/******************
 * addthis_petition section
 */
 
function takepart_addthis_petition_block_info(&$blocks){
  $blocks['addthis_petition'] = array(
    'info' => t('AddThis - petition'),
  );
}

function takepart_addthis_petition_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_petition_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-petition-block',
  );
}

function takepart_addthis_petition_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_petition'){

    $meta_data = array(
      '#tag' => 'meta',
      '#type' => 'html_tag',
      '#attributes' => array(
        'property' => 'og:title',
        'content' => 'Sign the WATER BILL OF RIGHTS',
      ),
    );
    drupal_add_html_head($meta_data, 'takepart_addthis_petition_block:facebook-meta-title-tag');

    $meta_data = array(
      '#tag' => 'meta',
      '#type' => 'html_tag',
      '#attributes' => array(
        'property' => 'og:description',
        'content' => "Join TakePart.com and some of America's most prominent environmental nonprofits in demanding clean drinking water and upgraded infrastructure for everyone in the U.S.",
      ),
    );
    drupal_add_html_head($meta_data, 'takepart_addthis_petition_block:facebook-meta-description-tag');

    $meta_data = array(
      '#tag' => 'meta',
      '#type' => 'html_tag',
      '#attributes' => array(
        'property' => 'og:image',
        'content' => url(drupal_get_path('module','takepart_addthis') . '/images/water_thumb.jpg', array('absolute' => TRUE)),
      ),
    );
    drupal_add_html_head($meta_data, 'takepart_addthis_petition_block:facebook-meta-image-tag');

    drupal_add_css(drupal_get_path('module', 'takepart_addthis') . '/css/takepart-addthis-petition-block.css', array('group' => CSS_DEFAULT, 'type' => 'file'));

    drupal_add_js(drupal_get_path('module', 'takepart_addthis') . '/js/takepart-addthis-petition-block.js', array('group' => JS_DEFAULT, 'type' => 'file'));

    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_petition_block', array()
    );

    return $block;
  }
}

function takepart_addthis_petition_block_configure($delta){
  $form = array(); 
  if($delta == 'addthis_petition'){
  }
  return $form;
}

function takepart_addthis_petition_block_save($delta, $edits){
  if($delta == 'addthis_petition'){
  }
}

/******************
 * addthis_ajax_form section
 */
 
function takepart_addthis_ajax_form_block_info(&$blocks){
  $blocks['addthis_ajax_form'] = array(
    'info' => t('AddThis - ajax form'),
  );
}

function takepart_addthis_ajax_form_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_ajax_form_block'] = array(
    'variables' => array(
      'share_form' => NULL,
    ),
    'template' => 'theme/takepart-addthis-ajax-form-block',
  );
}

function takepart_addthis_ajax_form_block_view($delta = ''){
  $block = array();
  //there is only one delta here, switch anyway
  if($delta == 'addthis_ajax_form'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_ajax_form_block', 
      array(
        'share_form' => drupal_get_form('_takepart_addthis_ajax_form'),
      )
    );
    return $block;
  }
}

function takepart_addthis_ajax_form_block_configure($delta){
  $form = array(); 
  if($delta == 'addthis_ajax_form'){
  }
  return $form;
}

function takepart_addthis_ajax_form_block_save($delta, $edits){
  if($delta == 'addthis_ajax_form'){
  }
}

function _takepart_addthis_ajax_form($form, &$form_state, $default_email) {
  
  $mail = $_COOKIE['petition_signed_as'];
  if (! valid_email_address($mail)) {
    $mail = '';
  }
  
  $form['share_result'] = array(
    '#type' => 'markup',
    '#prefix' => '<div id="share_result">',
    '#suffix' => '</div>',
    '#markup' => "",
  );
    
  $form['share_with'] = array(
    '#title' => t('Share via E-mail'),
    '#type' => 'textarea',
    '#resizable' => FALSE,
    '#default_value' => '',
  );

  $form['your_email'] = array(
    '#title' => t('Your E-mail'),
    '#type' => 'textfield',
    '#default_value' => $mail,
    '#size' => 30,
  );

  $form['your_name'] = array(
    '#title' => t('Your Name'),
    '#type' => 'textfield',
    '#default_value' => '',
    '#size' => 30,
  );

  $form['box'] = array(
    '#type' => 'markup',
    '#prefix' => '<div id="box">',
    '#suffix' => '</div>',
    '#markup' => "Subject: Let's do this Amazing Cause Together!",
  );
    
  $form['your_message'] = array(
    '#title' => t('Your Message:'),
    '#type' => 'textarea',
    '#resizable' => FALSE,
    '#default_value' => '',
  );
  
  $form['actions'] = array(
    '#weight' => 100,
  );

  $form['actions']['submit'] = array(
    '#type' => 'image_button',
    '#src' => drupal_get_path('module', 'takepart_petition') . '/images/petition-submit.png',
    '#attributes' => array(
      'alt' => t('Submit'),
    ),
    '#ajax' => array(
      'callback' => '_takepart_addthis_ajax_form_callback',
      'wrapper' => 'share_result',
      'name' => 'submit1',
    ),
  );

  return $form;
}

function _takepart_addthis_ajax_form_callback($form, $form_state) {

  $errors = array();

  $share_list = array();
  $share_with = $form_state['values']['share_with'];
  foreach (split(',', $share_with) as $share_email) {
    if (valid_email_address(trim($share_email))) {
      $share_list[] = trim($share_email);
    } else {
      $errors[] = 'Share via E-mail must be a comma separated list of email addresses.';
      break;
    }
  }

  $your_email = trim($form_state['values']['your_email']);
  if (! valid_email_address($your_email)) {
    $errors[] = 'Your E-Mail is required.';
  }
  
  $your_name = trim($form_state['values']['your_name']);
  if (strlen($your_name) == 0) {
    $errors[] = 'Your Name is required.';
  }

  $element = $form['share_result'];
  if (count($errors) == 0) {
    $element['#markup'] = "shared";
  } else {
	$markup  = '<div id="console">';
	$markup .= '<div class="limiter clearfix">';
	$markup .= '<div class="messages error">';
	$markup .= '<h2 class="element-invisible">Error message</h2>';
	$markup .= '<ul>';
	foreach ($errors as $error) {
	  $markup .= '<li>'. $error .'</li>';
	}
	$markup .= '</ul></div></div></div>';
    $element['#markup'] = $markup;
  }

  return $element;
}
