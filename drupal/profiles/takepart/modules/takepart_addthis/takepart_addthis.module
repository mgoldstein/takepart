<?php
/**
 * @file
 * This is the TakePart AddThis Blocks module.
 */
 /**
 * Implement hook_permission().
 */
function takepart_addthis_permission() {
  return array(
    'administer takepart_addthis' => array(
      'title' => 'Administer AddThis sharing widget',
      'description' => 'Change which services are shown, color, etc and add addthis.com username',
    ),
  );
}

/**
 * Implement of hook_menu().
 */
function takepart_addthis_menu() {
  $items = array();

  $items['admin/config/system/takepart-addthis'] = array(
    'title'            => t('AddThis'),
    'description'      => t('Set default settings for <a href="http://www.addthis.com/">AddThis</a> button.'),
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('takepart_addthis_admin_settings'),
    'access arguments' => array('administer takepart_addthis'),
    'file'             => 'takepart_addthis.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_preprocess().
 *
 * Attaches a few key strings to $variables for use by the template, including a
 * string full of custom buttons and the AddThis public ID.
 */
function takepart_addthis_preprocess(&$variables, $hook) {
  $ADD_THIS_PUB_ID = variable_get('takepart_addthis_pub_id','ra-4e48103302adc2d8');
  drupal_add_js(drupal_get_path('module','takepart_addthis') . '/js/exaddthis.js', 'file');
  drupal_add_js('http://s7.addthis.com/js/250/addthis_widget.js#pubid=' . $ADD_THIS_PUB_ID, 'external');

  //<a class="addthis_button_digg">Digg this</a>

  $takepart_blogpost_custom_btns =<<<EOS
<a class="addthis_button_stumbleupon">Stumble this</a>
<a class="addthis_button_email">E-mail this</a>
EOS;
/* To add a print friendly button, you need to the following line to the $takepart_blogpost_custom_btns:
<a class="addthis_button_print">Print</a>
*/
  $variables['addthis_custom_buttons']              = $takepart_blogpost_custom_btns;
  $variables['addthis_pubid']                       = $ADD_THIS_PUB_ID;
  $variables['takepart_addthis_tweet_via']          = variable_get('takepart_addthis_tweet_via','');
  $variables['takepart_addthis_facebook_like_text'] = variable_get('takepart_addthis_facebook_like_text','like');
}

function takepart_addthis_views_api() {
  return array(
    'api' => '3.0-alpha1',
  );
}

//hook_block_info() router
function takepart_addthis_block_info(){
  $zeBlocks = array();

  takepart_addthis_footer_block_info($zeBlocks);
  takepart_addthis_full_block_info($zeBlocks);
  takepart_addthis_rightrail_block_info($zeBlocks);
  takepart_addthis_simple_block_info($zeBlocks);
  takepart_addthis_petition_block_info($zeBlocks);
  takepart_addthis_vidpop_block_info($zeBlocks);
  takepart_addthis_ajax_form_block_info($zeBlocks);

  return $zeBlocks;
}

//hook_theme() router
function takepart_addthis_theme(){
  $ret_arr = array();

  takepart_addthis_footer_theme($ret_arr);
  takepart_addthis_full_theme($ret_arr);
  takepart_addthis_rightrail_theme($ret_arr);
  takepart_addthis_simple_theme($ret_arr);
  takepart_addthis_petition_theme($ret_arr);
  takepart_addthis_vidpop_theme($ret_arr);
  takepart_addthis_ajax_form_theme($ret_arr);
  return $ret_arr;
}

//hook_block_view() router
function takepart_addthis_block_view($delta = ''){
  $ret_view = array();

  switch($delta) {
    case 'addthis_footer':
      $ret_view = takepart_addthis_footer_block_view($delta);
      break;
    case 'addthis_full':
      $ret_view = takepart_addthis_full_block_view($delta);
      break;
    case 'addthis_rightrail':
      $ret_view = takepart_addthis_rightrail_block_view($delta);
      break;
    case 'addthis_simple':
      $ret_view = takepart_addthis_simple_block_view($delta);
      break;
    case 'addthis_petition':
      $ret_view = takepart_addthis_petition_block_view($delta);
      break;
    case 'addthis_vidpop':
      $ret_view = takepart_addthis_vidpop_block_view($delta);
      break;
    case 'addthis_ajax_form':
      $ret_view = takepart_addthis_ajax_form_block_view($delta);
      break;
  }

  return $ret_view;
}

//hook_block_configure() router
function takepart_addthis_block_configure($delta = ''){
  $ret_form = array();

  switch($delta){
    case 'addthis_footer':
      $ret_form = takepart_addthis_footer_block_configure($delta);
      break;
    case 'addthis_full':
      $ret_form = takepart_addthis_full_block_configure($delta);
      break;
    case 'addthis_rightrail':
      $ret_form = takepart_addthis_rightrail_block_configure($delta);
      break;
    case 'addthis_simple':
      $ret_form = takepart_addthis_simple_block_configure($delta);
      break;
    case 'addthis_petition':
      $ret_form = takepart_addthis_petition_block_configure($delta);
      break;
    case 'addthis_vidpop':
      $ret_form = takepart_addthis_vidpop_block_configure($delta);
      break;
    case 'addthis_ajax_form':
      $ret_form = takepart_addthis_ajax_form_block_configure($delta);
      break;
  }

  return $ret_form;
}

//hook_block_save() router
function takepart_addthis_block_save($delta = '', $edits = array()){
  switch($delta){
    case 'addthis_footer':
      takepart_addthis_footer_block_save($delta, $edits);
      break;
    case 'addthis_full':
      takepart_addthis_full_block_save($delta, $edits);
      break;
    case 'addthis_rightrail':
      takepart_addthis_rightrail_block_save($delta, $edits);
      break;
    case 'addthis_simple':
      takepart_addthis_simple_block_save($delta, $edits);
      break;
    case 'addthis_petition':
      takepart_addthis_petition_block_save($delta, $edits);
      break;
    case 'addthis_vidpop':
      takepart_addthis_vidpop_block_save($delta, $edits);
      break;
    case 'addthis_ajax_form':
      takepart_addthis_ajax_form_block_save($delta, $edits);
      break;
  }
}

/******************
 * AddThis_full section
 */

function takepart_addthis_full_block_info(&$blocks){
  $blocks['addthis_full'] = array(
    'info' => t('AddThis - full'),
  );
}

function takepart_addthis_full_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_full_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-full-block',
  );
}

function takepart_addthis_full_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_full'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_full_block', array()
    );

    return $block;
  }
}

function takepart_addthis_full_block_configure($delta){
  $form = array();

  if($delta == 'addthis_full'){
  }

  return $form;
}

function takepart_addthis_full_block_save($delta, $edits){
  if($delta == 'addthis_full'){
  }
}

/******************
 * AddThis_rightrail section
 */

function takepart_addthis_rightrail_block_info(&$blocks){
  $blocks['addthis_rightrail'] = array(
    'info' => t('AddThis - rightrail'),
  );
}

function takepart_addthis_rightrail_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_rightrail_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-rightrail-block',
  );
}

function takepart_addthis_rightrail_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_rightrail'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_rightrail_block', array()
    );

    return $block;
  }
}

function takepart_addthis_rightrail_block_configure($delta){
  $form = array();

  if($delta == 'addthis_rightrail'){
  }

  return $form;
}

function takepart_addthis_rightrail_block_save($delta, $edits){
  if($delta == 'addthis_rightrail'){
  }
}

/******************
 * addthis_footer section
 */

function takepart_addthis_footer_block_info(&$blocks){
  $blocks['addthis_footer'] = array(
    'info' => t('AddThis - footer'),
  );
}

function takepart_addthis_footer_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_footer_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-footer-block',
  );
}

function takepart_addthis_footer_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_footer'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_footer_block', array()
    );

    return $block;
  }
}

function takepart_addthis_footer_block_configure($delta){
  $form = array();

  if($delta == 'addthis_footer'){
  }

  return $form;
}

function takepart_addthis_footer_block_save($delta, $edits){
  if($delta == 'addthis_footer'){
  }
}

/******************
 * addthis_top section
 */

function takepart_addthis_simple_block_info(&$blocks){
  $blocks['addthis_simple'] = array(
    'info' => t('AddThis - Share FB and Tweet'),
  );
}

function takepart_addthis_simple_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_simple_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-simple-block',
  );
}

function takepart_addthis_simple_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_simple'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_simple_block', array()
    );

    return $block;
  }
}

function takepart_addthis_simple_block_configure($delta){
  $form = array();

  if($delta == 'addthis_simple'){
  }

  return $form;
}

function takepart_addthis_simple_block_save($delta, $edits){
  if($delta == 'addthis_simple'){
  }
}

/******************
 * addthis_vidpop section
 */

function takepart_addthis_vidpop_block_info(&$blocks){
  $blocks['addthis_vidpop'] = array(
    'info' => t('AddThis - Embedded Video Popup'),
  );
}

function takepart_addthis_vidpop_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_vidpop_block'] = array(
    'variables' => array(),
    'template' => 'theme/takepart-addthis-vidpop-block',
  );
}

function takepart_addthis_vidpop_block_view($delta = ''){
  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_vidpop'){
    //create the block
    $block['subject'] = t('');
    $block['content'] = theme(
      'takepart_addthis_vidpop_block', array()
    );

    return $block;
  }
}

function takepart_addthis_vidpop_block_configure($delta){
  $form = array();

  if($delta == 'addthis_vidpop'){
  }

  return $form;
}

function takepart_addthis_vidpop_block_save($delta, $edits){
  if($delta == 'addthis_vidpop'){
  }
}

/******************
 * addthis_petition section
 */

function takepart_addthis_petition_block_info(&$blocks){
  $blocks['addthis_petition'] = array(
    'info' => t('AddThis - petition'),
  );
}

function takepart_addthis_petition_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_petition_block'] = array(
    'variables' => array(
      'ui_email_note' => '',
      'ui_email_from' => '',
      'twitter_template' => '',
    ),
    'template' => 'theme/takepart-addthis-petition-block',
  );
}

function takepart_addthis_petition_block_view($delta = ''){
  $block = array();

  if($delta == 'addthis_petition'){

    drupal_add_css(
      drupal_get_path('module', 'takepart_addthis')
        . '/css/takepart-addthis-petition-block.css',
      array('group' => CSS_DEFAULT, 'type' => 'file')
    );

    drupal_add_js(
      drupal_get_path('module', 'takepart_addthis')
        . '/js/takepart-addthis-petition-block.js',
      array('group' => JS_DEFAULT, 'type' => 'file')
    );

    $block['subject'] = t('');
    $block['content'] = theme('takepart_addthis_petition_block', array());
  }
  return $block;
}

function takepart_addthis_petition_block_configure($delta){
  $form = array();
  if($delta == 'addthis_petition'){
  }
  return $form;
}

function takepart_addthis_petition_block_save($delta, $edits){
  if($delta == 'addthis_petition'){
  }
}

/******************
 * addthis_ajax_form section
 */

function takepart_addthis_ajax_form_block_info(&$blocks){
  $blocks['addthis_ajax_form'] = array(
    'info' => t('AddThis - Petition Thank You'),
  );
}

function takepart_addthis_ajax_form_theme(&$theme_funcs){
  $theme_funcs['takepart_addthis_ajax_form_block'] = array(
    'variables' => array(
      'ui_email_note' => '',
      'ui_email_from' => '',
      'twitter_template' => '',
      'thank_you_message' => '',
    ),
    'template' => 'theme/takepart-addthis-ajax-form-block',
  );
}

function takepart_addthis_ajax_form_block_view($delta = ''){

  $block = array();

  //there is only one delta here, switch anyway
  if($delta == 'addthis_ajax_form'){

    // add the cookie library for the tracking event latch
    drupal_add_library('system', 'jquery.cookie');

    drupal_add_js(
      drupal_get_path('module', 'takepart_addthis')
        . '/js/takepart-addthis-petition-block.js',
      array('group' => JS_DEFAULT, 'type' => 'file')
    );

    drupal_add_js(
      drupal_get_path('module', 'takepart_addthis')
        . '/js/takepart-petition-metrics.js',
      array('group' => JS_DEFAULT, 'type' => 'file')
    );

    // get the signature from the url
    $id = isset($_GET['signature']) ? $_GET['signature'] : '';
    if ($id !== '' && (!is_numeric($id) || intval($id) != $id || $id < 0)) { $id = ''; }
    if (!empty($id)) { $signature = petition_signature_load($id); }
    if (!empty($signature)) {

      $petition = petition_load($signature->petition_id);
      $email_share_msg_var = "petition:{$petition->type}:{$petition->petition_id}:email_share_msg";
      $twitter_share_msg_var = "petition:{$petition->type}:{$petition->petition_id}:twitter_share_msg";

      // TODO: Remove this when generic petitions have been implemented
      $newsletters = array();
      $lang = $signature->language;
      if (isset($signature->field_wbor_newsletter_opt_in)) {
        $opt_in = $signature->field_wbor_newsletter_opt_in[$lang][0]['value'];
        if (! empty($opt_in)) {
          $newsletters[] = 'Last Call at the Oasis';
        }
      }

      $settings = array(
        'sharing' => array(
          'email' => isset($_COOKIE['petition_signed_as']) ? $_COOKIE['petition_signed_as'] : '',
          'email_msg' =>  variable_get($email_share_msg_var, ''),
          'twitter_msg' => variable_get($twitter_share_msg_var, ''),
        ),
          'petition' => array(
          'name' => $petition->name,
          'track_latch' => $petition->type . '_track',
          'newsletters' => $newsletters,
        )
      );
      drupal_add_js($settings, 'setting');
    }

    $thank_you_message  = "<p>Your signature has been added to the petition, and our movement is one person stronger!</p>";
    $thank_you_message .= "<p>Every signature matters - share yours with people you know who also care about progress. Ask your friends, family, coworkers, and neighbors to join our campaign.</p>";
    $thank_you_message .= "<p>You can share the petition on Facebook or Twitter, or send an email using the form below.</p>";

    $block['subject'] = t('');
    $block['content'] = theme('takepart_addthis_ajax_form_block', array(
      'thank_you_message' => $thank_you_message,s
    ));
  }
  return $block;
}

function takepart_addthis_ajax_form_block_configure($delta){
  $form = array();
  if($delta == 'addthis_ajax_form'){
  }
  return $form;
}

function takepart_addthis_ajax_form_block_save($delta, $edits){
  if($delta == 'addthis_ajax_form'){
  }
}
