<?php


/***
 * Implementation of hook_init()
 *
 * creates global js var detected_mobile_browser
 *
 */
function rightrail_popups_init() {
  $path = drupal_get_path('module', 'rightrail_popups');
  drupal_add_css($path . '/css/rightrail_popups.css', array('every_page' => TRUE));
  drupal_add_js($path . '/js/rightrail_popups.js', 'file');
}


/***
 * Implementation of hook_preprocess_node()
 *
 * @param $vars
 * @param $hook
 */
function rightrail_preprocess_node(&$vars, $hook) {
}


  /***
 * Implementation of hook_boxes_box_load_alter()
 *
 * @param $box
 * @param $delta
 */
function rightrail_popups_boxes_box_load_alter(&$box, $delta) {
  if (isset($box->options['additional_classes'])) {
    if ($box->options['additional_classes'] == 'video-popup') {
      // get the id of the video
      // pattern like:
      //     videoData[0][0] = ["lvt4b_qwC_Q",                                      // youtube id
      //       "http://www.takepart.com/sites/default/files/temp_video_thumb.png",  // preview
      //       "This is caption 1",                                                 // caption
      //       "This is description 1"];                                            // description

      $body = $box->options['body'];
      preg_match("/www.youtube.com\/embed\/([^\"]+)\"/", $body, $res);
      $video_id = $res[1];
      $rr_class = 'rr-' . $video_id;

      // prepare popup vars
      if (variable_get('takepart_vidpop_banners_enabled', false)) {
        // get the ad banner
        $top_banner = takepart_vidpop_get_banner();
        // get the logo to the left of the ad banner
        $banner_tp_logo = theme('image', array(
            'path' => drupal_get_path('module', 'takepart') . '/modules/takepart_vidpop/css/images/TP_modal_icon.png',
            'width' => '58px',
            'height' => '58px',
            'title' => 'Takepart',
          )
        );
      }

      // format the video for display in popup; this will become the left side of the video
      $fmt_pop = <<<EOT
  <div class="right-rail-vidpop" style="height: 360px; width: 640px;">
    <iframe width="640" height="411" frameborder="0" type="text/html" class="youtube-player right-rail-vidpop-iframe" src="http://www.youtube.com/embed/$video_id?version=3&amp;wmode=opaque" style="height: 360px; width: 640px;"></iframe>
  </div>
EOT;

      $popup = theme('rightrail_video_popup', array('p_title' => $box->title, 'p_video_id' => $video_id, 'p_top_banner' => $top_banner, 'p_banner_tp_logo' => $banner_tp_logo, 'p_fmt_pop' => $fmt_pop));

      // replace box contents with preview
      if ((takepart_vidpop_mobile_browser()) || (takepart_vidpop_is_ipad())) {
        $vid_link = "http://www.youtube.com/embed/" . $video_id;
        $preview = theme('rightrail_video_preview_mobile', array('p_title' => $box->title, 'p_video_id' => $video_id, 'p_vid_link' => $vid_link, 'rr_class' => $rr_class));
      }
      else {
        $preview = theme('rightrail_video_preview', array('p_title' => $box->title, 'p_video_id' => $video_id, 'p_popup' => $popup, 'rr_class' => $rr_class));
      }
      $box->options['body'] = $preview;
    }
  }
}

/**
 * Implement hook_theme().
 *
 * This one is used as the base to reduce errors when updating.
 */
function rightrail_popups_theme() {
  $template_path = drupal_get_path('module', 'rightrail_popups') . '/theme';

  return array(
    'rightrail_video_preview' => array(
      'path'      => $template_path,
      'template'  => 'rightrail-video-preview',
      'variables' => array('p_title' => NULL, 'p_video_id' => NULL, 'p_popup' => NULL, 'rr_class' => NULL),
    ),
    'rightrail_video_preview_mobile' => array(
      'path'      => $template_path,
      'template'  => 'rightrail-video-preview-mobile',
      'variables' => array('p_title' => NULL, 'p_video_id' => NULL, 'p_vid_link' => NULL, 'rr_class' => NULL),
    ),
    'rightrail_video_popup' => array(
      'path'      => $template_path,
      'template'  => 'rightrail-video-popup',
      'variables' => array('p_title' => NULL, 'p_video_id' => NULL, 'p_body' => NULL, 'p_fmt_pop' => NULL),



      ),
  );
}


/***
 * @param $vars
 *
 * Implementation of hook_preprocess_html
 */
function rightrail_popups_preprocess_html(&$vars) {
  if (isset($vars['page']['sidebar_second'])) {
    foreach ($vars['page']['sidebar_second'] as $box_id => $data) {
      if (substr($box_id, 0, 6) == 'boxes_') {
        if (isset($data['#block']->additional_classes)) {
          if ($data['#block']->additional_classes == 'video-popup') {
            // this one is a video popup block
            // get the youtube ID, it will be in the rrpop-XXXX class tag somewhere
            // in the content; i.e. rrpop-Mew33kt7D6c, from the line
            //
            // this is weird: different location for markup is user is logged in or not
            if (user_is_logged_in()) {
              if (preg_match("/rrpop-([^\"]+)\"/", $data['content']['#markup'], $res))  {
                $youtube_id = $res[1];
                unipop_set_metric_page_load('set', $youtube_id, $data['#block']->title, 'right railvideo');
              }
            } else {
              if (preg_match("/rrpop-([^\"]+)\"/", $data['#markup'], $res))  {
                $youtube_id = $res[1];
                unipop_set_metric_page_load('set', $youtube_id, $data['#block']->title, 'right railvideo');
              }
            }
          }
        }
      }
    }
  }
}



