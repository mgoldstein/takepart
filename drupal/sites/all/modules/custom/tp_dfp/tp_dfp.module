<?php
/**
 * @file
 * Google Doubleclick for Publishers integration with TakePart
 *
 */

/**
 * Implements hook_menu()
 */
function tp_dfp_menu(){
  $items = array();

  $items['admin/config/dfp'] = array(
    'title' => t('DFP for TakePart'),
    'description' => t('Backend integration with Google Doubleclick for Publishing'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tp_dfp_admin_config'),
    'access arguments' => array('access administration pages'),
    'file' => 'tp_dfp.admin.inc'
  );

  return $items;
}


/**
 * Implements hook_entity_presave()
 */
function tp_dfp_entity_presave($entity, $type) {

  // Only run this on sponsored taxonomy terms
  if($type == 'taxonomy_term' && $entity->vocabulary_machine_name == 'sponsor'){
    if(isset($entity->field_dfp_id['und'][0])){

      // Get DFP creatives
      $id = $entity->field_dfp_id['und'][0]['value'];
      $creative = _dfp_get_creative($id);

      if(isset($creative[0])){
        // Update existing creative

      }else{
        //create the new creative
      }

    }
  }

}

/**
 * Helper function that returns values for creatives
 */
function _dfp_get_creative($id){

  // Find Google's DFP lib.  Otherwise, use libraries API.
  $googleads_lib_path = function_exists('libraries_get_path') ? libraries_get_path('googleads-php-lib') : 'sites/all/libraries/googleads-php-lib';
  $googleads_dfp = $googleads_lib_path. '/src/Google/Api/Ads/Dfp';

  if ($googleads_dfp) {
    set_include_path(get_include_path() . PATH_SEPARATOR . $googleads_lib_path. '/src');
    @require_once($googleads_dfp. '/Lib/DfpUser.php');
    @require_once($googleads_dfp. '/Util/v201508/StatementBuilder.php');
  }

  $results = array();

  try {

    // Get DfpUser from credentials
    $user = new DfpUser();

    // Get the CreativeService.
    $creativeService = $user->GetService('CreativeService', v201508);

    // Create a statement to select all creatives.
    $statementBuilder = new StatementBuilder();
    $statementBuilder->Where('ID = :id')
      ->OrderBy('id ASC')
      ->Limit(StatementBuilder::SUGGESTED_PAGE_LIMIT)
      ->WithBindVariableValue('id', $id);

    // Default for total result set size.
    $totalResultSetSize = 0;

    do {
      // Get creatives by statement.
      $page = $creativeService->getCreativesByStatement(
        $statementBuilder->ToStatement());

      // Display results.
      if (isset($page->results)) {
        $totalResultSetSize = $page->totalResultSetSize;
        $i = $page->startIndex;
        foreach ($page->results as $creative) {
          $results[] = array($creative->id, $creative->name);
        }
      }

      $statementBuilder->IncreaseOffsetBy(StatementBuilder::SUGGESTED_PAGE_LIMIT);
    } while ($statementBuilder->GetOffset() < $totalResultSetSize);

  } catch (Exception $e) {
    printf("%s\n", $e->getMessage());
  }

  return $results;
}





/**
 * Helper function to create creative
 */
function _dfp_create_creative($creativeTemplateName, $advertiserId, $creativeTemplateId, $variables){

  require_once 'Google/Api/Ads/Dfp/Lib/DfpUser.php';
  require_once 'Google/Api/Ads/Common/Util/MediaUtils.php';
  require_once dirname(__FILE__) . '/../../../Common/ExampleUtils.php';

  try {
    // Get DfpUser from credentials in "../auth.ini"
    // relative to the DfpUser.php file's directory.
    $user = new DfpUser();

    // Get the CreativeService.
    $creativeService = $user->GetService('CreativeService', 'v201508');

    // Create the local custom creative object.
    $templateCreative = new TemplateCreative();
    $templateCreative->name = $creativeTemplateName;
    $templateCreative->advertiserId = $advertiserId;
    $templateCreative->creativeTemplateId = $creativeTemplateId;

    // Set the creative size.
    // Make size static for now
    $templateCreative->size = new Size(300, 250, false);

    // TODO: Values found in variables array
    // Create the asset variable value.
    $assetVariableValue = new AssetCreativeTemplateVariableValue();
    $assetVariableValue->uniqueName = 'Imagefile';
    $assetVariableValue->assetByteArray = MediaUtils::GetBase64Data(
      'http://www.google.com/intl/en/adwords/select/images/samples/inline.jpg');
    // Filenames must be unique.
    $assetVariableValue->fileName = sprintf('image%s.jpg', uniqid());
    $templateCreative->creativeTemplateVariableValues[] = $assetVariableValue;

    // Create the image width variable value.
    $imageWidthVariableValue = new LongCreativeTemplateVariableValue();
    $imageWidthVariableValue->uniqueName = 'Imagewidth';
    $imageWidthVariableValue->value = 300;
    $templateCreative->creativeTemplateVariableValues[] =
      $imageWidthVariableValue;

    // Create the image height variable value.
    $imageHeightVariableValue = new LongCreativeTemplateVariableValue();
    $imageHeightVariableValue->uniqueName = 'Imageheight';
    $imageHeightVariableValue->value = 250;
    $templateCreative->creativeTemplateVariableValues[] =
      $imageHeightVariableValue;

    // Create the URL variable value.
    $urlVariableValue = new UrlCreativeTemplateVariableValue();
    $urlVariableValue->uniqueName = 'ClickthroughURL';
    $urlVariableValue->value = 'www.google.com';
    $templateCreative->creativeTemplateVariableValues[] = $urlVariableValue;

    // Create the target window variable value.
    $targetWindowVariableValue = new StringCreativeTemplateVariableValue();
    $targetWindowVariableValue->uniqueName = 'Targetwindow';
    $targetWindowVariableValue->value = '_blank';
    $templateCreative->creativeTemplateVariableValues[] =
      $targetWindowVariableValue;

    // Create the template creative on the server.
    $templateCreatives =
      $creativeService->createCreatives(array($templateCreative));

    foreach ($templateCreatives as $templateCreative) {
      printf("A template creative with ID '%s', name '%s', and type '%s' was "
        . "created and can be previewed at: %s\n", $templateCreative->id,
        $templateCreative->name, get_class($templateCreative),
        $templateCreative->previewUrl);
    }
  } catch (OAuth2Exception $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (ValidationException $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (Exception $e) {
    printf("%s\n", $e->getMessage());
  }
}


/**
 * Helper function to update creative
 */
function _dfp_update_creative($creativeId){
  $path = dirname(__FILE__) . '/../../../../lib';
  set_include_path(get_include_path() . PATH_SEPARATOR . $path);

  require_once 'Google/Api/Ads/Dfp/Lib/DfpUser.php';
  require_once 'Google/Api/Ads/Dfp/Util/v201508/StatementBuilder.php';
  require_once dirname(__FILE__) . '/../../../Common/ExampleUtils.php';

  try {
    // Get DfpUser from credentials in "../auth.ini"
    // relative to the DfpUser.php file's directory.
    $user = new DfpUser();

    // Log SOAP XML request and response.
    $user->LogDefaults();

    // Get the CreativeService.
    $creativeService = $user->GetService('CreativeService', 'v201508');

    // Create a statement to select a single creative by ID.
    $statementBuilder = new StatementBuilder();
    $statementBuilder->Where('id = :id')
      ->OrderBy('id ASC')
      ->Limit(1)
      ->WithBindVariableValue('id', $creativeId);

    // Get the creative.
    $page = $creativeService->getCreativesByStatement(
      $statementBuilder->ToStatement());
    $creative = $page->results[0];

    // TODO: update ALL fields if they exist
    if ($creative instanceof HasDestinationUrlCreative) {
      // Update the destination URL of the creative.
      $creative->destinationUrl = 'https://news.google.com';

      // Update the creative on the server.
      $creatives = $creativeService->updateCreatives(array($creative));

      foreach ($creatives as $updatedCreative) {
        printf("Creative with ID %d, and name '%s' was updated.\n",
          $updatedCreative->id, $updatedCreative->name);
      }
    } else {
      printf("No creatives were updated.\n");
    }
  } catch (OAuth2Exception $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (ValidationException $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (Exception $e) {
    printf("%s\n", $e->getMessage());
  }
}