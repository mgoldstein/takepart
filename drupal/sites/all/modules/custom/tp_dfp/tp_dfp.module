<?php
/**
 * @file
 * Google Doubleclick for Publishers integration with TakePart
 *
 */

/**
 * Implements hook_menu()
 */
function tp_dfp_menu(){
  $items = array();

  $items['admin/config/dfp'] = array(
    'title' => t('DFP for TakePart'),
    'description' => t('Backend integration with Google Doubleclick for Publishing'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tp_dfp_admin_config'),
    'access arguments' => array('access administration pages'),
    'file' => 'tp_dfp.admin.inc'
  );

  return $items;
}


/**
 * Implements hook_entity_presave()
 */
function tp_dfp_entity_presave($entity, $type) {

  // Only run this on sponsored taxonomy terms
  if($type == 'taxonomy_term' && $entity->vocabulary_machine_name == 'sponsor'){
    if(isset($entity->field_dfp_id['und'][0])){

      // Set DFP user credentials
      _dfp_get_user_credentials();

      // Get DFP creatives
      $creatives = _dfp_get_creatives();
      dpm($creatives, 'creatives');

      //Get all templates to see if one already exists

      //Create template if it hasn't been created

      //Update template if one already exists
    }
  }


  // Setup DFP
//  _dfp_init();

  //Create the template if it hasn't been created, otherwise update the existing one


}

function _dfp_init(){

  //TODO: Add drupal_static caching in the event that DFP has already been initialized

  // Find Google's DFP lib.  Use libraries API if enabled.
  $googleads_lib_path = function_exists('libraries_get_path') ? libraries_get_path('googleads-php-lib') : 'sites/all/libraries/googleads-php-lib';
  $googleads_dfp = $googleads_lib_path. '/src/Google/Api/Ads/Dfp';

  set_include_path(get_include_path() . PATH_SEPARATOR . $googleads_lib_path. '/src');
  if (!class_exists('DfpUser') && !@require_once($googleads_dfp. '/Lib/DfpUser.php')) {
    $message = t('Failed to find the DFP php library at %filename.  Read the !readme', array(
      '!readme' => '<a href='. base_path() . '/' . drupal_get_path('module', 'tp_dpf') . '/README.txt>README.txt</a>',
      '%filename' => $googleads_dfp,
    ));
    drupal_set_message($message, 'error');
    watchdog('tp_dfp', $message);
    return NULL;
  }
}

/**
 * Helper function that returns values for creatives
 */
function _dfp_get_creatives(){

  // Needs version

  //TODO: set version
  // Find Google's DFP lib.  Otherwise, use libraries API.
  $googleads_lib_path = function_exists('libraries_get_path') ? libraries_get_path('googleads-php-lib') : 'sites/all/libraries/googleads-php-lib';
  $googleads_dfp = $googleads_lib_path. '/src/Google/Api/Ads/Dfp';

  if ($googleads_dfp) {
    set_include_path(get_include_path() . PATH_SEPARATOR . $googleads_lib_path. '/src');
    @require_once($googleads_dfp. '/Lib/DfpUser.php');
    @require_once($googleads_dfp. '/Util/'. VERSION. '/StatementBuilder.php');
  }else{
    return;
  }

  $results = array();

  try {

    // Get DfpUser from credentials
    $user = new DfpUser();

    // Get the CreativeService.
    $creativeService = $user->GetService('CreativeService', VERSION);

    // Create a statement to select all creatives.
    $statementBuilder = new StatementBuilder();
    $statementBuilder->OrderBy('id ASC')
      ->Limit(StatementBuilder::SUGGESTED_PAGE_LIMIT);

    // Default for total result set size.
    $totalResultSetSize = 0;

    do {
      // Get creatives by statement.
      $page = $creativeService->getCreativesByStatement(
        $statementBuilder->ToStatement());

      // Display results.
      if (isset($page->results)) {
        $totalResultSetSize = $page->totalResultSetSize;
        $i = $page->startIndex;
        foreach ($page->results as $creative) {
          $results[] = array($creative->id, $creative->name);
        }
      }

      $statementBuilder->IncreaseOffsetBy(StatementBuilder::SUGGESTED_PAGE_LIMIT);
    } while ($statementBuilder->GetOffset() < $totalResultSetSize);

  } catch (Exception $e) {
    printf("%s\n", $e->getMessage());
  }

  dpm($results, 'results');
  return $results;
}

function _dfp_create_creative(){

  require_once 'Google/Api/Ads/Dfp/Lib/DfpUser.php';
  require_once 'Google/Api/Ads/Common/Util/MediaUtils.php';
  require_once dirname(__FILE__) . '/../../../Common/ExampleUtils.php';

// Set the ID of the advertiser (company) that all creatives will be
// assigned to.
  $advertiserId = 'INSERT_ADVERTISER_COMPANY_ID_HERE';

  try {
    // Get DfpUser from credentials in "../auth.ini"
    // relative to the DfpUser.php file's directory.
    $user = new DfpUser();

    // Log SOAP XML request and response.
    $user->LogDefaults();

    // Get the CreativeService.
    $creativeService = $user->GetService('CreativeService', 'v201508');

    // Use the image banner with optional third party tracking template.
    $creativeTemplateId = 10000680;

    // Create the local custom creative object.
    $templateCreative = new TemplateCreative();
    $templateCreative->name = 'Template creative';
    $templateCreative->advertiserId = $advertiserId;
    $templateCreative->creativeTemplateId = $creativeTemplateId;

    // Set the creative size.
    $templateCreative->size = new Size(300, 250, false);

    // Create the asset variable value.
    $assetVariableValue = new AssetCreativeTemplateVariableValue();
    $assetVariableValue->uniqueName = 'Imagefile';
    $assetVariableValue->assetByteArray = MediaUtils::GetBase64Data(
      'http://www.google.com/intl/en/adwords/select/images/samples/inline.jpg');
    // Filenames must be unique.
    $assetVariableValue->fileName = sprintf('image%s.jpg', uniqid());
    $templateCreative->creativeTemplateVariableValues[] = $assetVariableValue;

    // Create the image width variable value.
    $imageWidthVariableValue = new LongCreativeTemplateVariableValue();
    $imageWidthVariableValue->uniqueName = 'Imagewidth';
    $imageWidthVariableValue->value = 300;
    $templateCreative->creativeTemplateVariableValues[] =
      $imageWidthVariableValue;

    // Create the image height variable value.
    $imageHeightVariableValue = new LongCreativeTemplateVariableValue();
    $imageHeightVariableValue->uniqueName = 'Imageheight';
    $imageHeightVariableValue->value = 250;
    $templateCreative->creativeTemplateVariableValues[] =
      $imageHeightVariableValue;

    // Create the URL variable value.
    $urlVariableValue = new UrlCreativeTemplateVariableValue();
    $urlVariableValue->uniqueName = 'ClickthroughURL';
    $urlVariableValue->value = 'www.google.com';
    $templateCreative->creativeTemplateVariableValues[] = $urlVariableValue;

    // Create the target window variable value.
    $targetWindowVariableValue = new StringCreativeTemplateVariableValue();
    $targetWindowVariableValue->uniqueName = 'Targetwindow';
    $targetWindowVariableValue->value = '_blank';
    $templateCreative->creativeTemplateVariableValues[] =
      $targetWindowVariableValue;

    // Create the template creative on the server.
    $templateCreatives =
      $creativeService->createCreatives(array($templateCreative));

    foreach ($templateCreatives as $templateCreative) {
      printf("A template creative with ID '%s', name '%s', and type '%s' was "
        . "created and can be previewed at: %s\n", $templateCreative->id,
        $templateCreative->name, get_class($templateCreative),
        $templateCreative->previewUrl);
    }
  } catch (OAuth2Exception $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (ValidationException $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (Exception $e) {
    printf("%s\n", $e->getMessage());
  }
}


function _dfp_update_creative(){
  $path = dirname(__FILE__) . '/../../../../lib';
  set_include_path(get_include_path() . PATH_SEPARATOR . $path);

  require_once 'Google/Api/Ads/Dfp/Lib/DfpUser.php';
  require_once 'Google/Api/Ads/Dfp/Util/v201508/StatementBuilder.php';
  require_once dirname(__FILE__) . '/../../../Common/ExampleUtils.php';

// Set the ID of the creative to update.
  $creativeId = 'INSERT_CREATIVE_ID_HERE';

  try {
    // Get DfpUser from credentials in "../auth.ini"
    // relative to the DfpUser.php file's directory.
    $user = new DfpUser();

    // Log SOAP XML request and response.
    $user->LogDefaults();

    // Get the CreativeService.
    $creativeService = $user->GetService('CreativeService', 'v201508');

    // Create a statement to select a single creative by ID.
    $statementBuilder = new StatementBuilder();
    $statementBuilder->Where('id = :id')
      ->OrderBy('id ASC')
      ->Limit(1)
      ->WithBindVariableValue('id', $creativeId);

    // Get the creative.
    $page = $creativeService->getCreativesByStatement(
      $statementBuilder->ToStatement());
    $creative = $page->results[0];

    // Only update the destination URL if it has one.
    if ($creative instanceof HasDestinationUrlCreative) {
      // Update the destination URL of the creative.
      $creative->destinationUrl = 'https://news.google.com';

      // Update the creative on the server.
      $creatives = $creativeService->updateCreatives(array($creative));

      foreach ($creatives as $updatedCreative) {
        printf("Creative with ID %d, and name '%s' was updated.\n",
          $updatedCreative->id, $updatedCreative->name);
      }
    } else {
      printf("No creatives were updated.\n");
    }
  } catch (OAuth2Exception $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (ValidationException $e) {
    ExampleUtils::CheckForOAuth2Errors($e);
  } catch (Exception $e) {
    printf("%s\n", $e->getMessage());
  }
}

/*
 * Helper function get to get user credentials
 * Variables are set on the admin form at /admin/config/dfp
 */
function _dfp_get_user_credentials(){

  //Detailed descriptions of these properties can be found at:
  //https://developers.google.com/doubleclick-publishers/docs/soap_xml

  /* The header networkCode is needed for every request except
   * NetworkService.makeTestNetwork and NetworkService.getAllNetworks
   */
  define('NETWORK_CODE', variable_get('dfp_network_code', '4355895'));

  /*
   * Any string of your choosing to identify your application to DFP.
   */
  define('APPLICATION_NAME', variable_get('dfp_application_name', 'TODO: set default'));

  /*
   * [OAUTH2]
   * If you do not have a client ID or secret, please create one of type
   * "installed application" in the Google API console:
   * https://cloud.google.com/console
   */
  define('CLIENT_ID', variable_get('dfp_client_id', 'TODO: set default'));
  define('CLIENT_SECRET', variable_get('dfp_client_secret', 'TODO: set default'));

  /*
   * If you already have a refresh token, enter it below. Otherwise, run
   * GetRefreshToken.php.
   */
  define('REFRESH_TOKEN', variable_get('dfp_refresh_token', 'TODO: set default'));


  /*
   * Define the version we are using
   */
  define('VERSION', 'v201508');

}