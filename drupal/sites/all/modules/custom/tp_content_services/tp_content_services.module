<?php

/**
 *  Implements hook_menu
 */
function tp_content_services_menu() {
  $items = array();

  //main group menu
  $items['admin/config/takepart/content_services'] = array(
    'title' => t('TakePart - Content Notify Services'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tp_content_services_admin_form'),
    'file' => 'tp_content_services.admin.inc',
    'file path' => drupal_get_path('module', 'tp_content_services') . '/forms',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * hook_node_insert
 */
function tp_content_services_node_insert($node) {
  if(in_array($node->type, array('openpublish_article','feature_article','openpublish_photo_gallery','video'))) {
    tp_content_services_notify_service($node, 'insert');
  }
}

/**
 * hook_node_update
 */
function tp_content_services_node_update($node) {
  if((isset($node->workbench_moderation['updating_live_revision']) && $node->workbench_moderation['updating_live_revision'] == 1)
    && in_array($node->type, array('openpublish_article','feature_article','openpublish_photo_gallery','video'))) {
    if($node->workbench_moderation['current']->published == 1 ||
      (isset($node->workbench_moderation['current']->unpublishing) && $node->workbench_moderation['current']->unpublishing == 1)){
      tp_content_services_notify_service($node, 'update');
    }
  }
}

/**
 * API call to service
 */
function tp_content_services_notify_service($node, $insup = '') {
  //tags
  $tags = _tp_content_services_get_tags($node);

  //author
  $author = _tp_content_services_get_authors($node);

  //description - content subhead
  $description = '';
  if($sub_head = field_get_items('node', $node, 'field_article_subhead')) {
    $description = $sub_head[0]['value'];
  } else if($sub_head = field_get_items('node', $node, 'field_subhead')){
    $description = $sub_head[0]['value'];
  }
  //image - full path to content image
  //thumbnail - path to image style
  $thumb = $image = '';
  if($field_thumb_image = field_get_items('node', $node, 'field_thumbnail')) {
    $field_thumb_image = file_load($field_thumb_image[0]['fid']);
    $image = file_create_url($field_thumb_image->uri);
    $thumb = image_style_url('media_thumbnail', $field_thumb_image->uri);
  }
  if(!$image) {
    if($field_main_image = field_get_items('node', $node, 'field_article_main_image')){
      $field_main_image = file_load($field_main_image[0]['fid']);
      $image = file_create_url($field_main_image->uri);
    } elseif ($field_main_image = field_get_items('node', $node, 'field_gallery_main_image')) {
      $field_main_image = file_load($field_main_image[0]['fid']);
      $image = file_create_url($field_main_image->uri);
    }
  }
  if(!$thumb) {
    $thumb = $image;
  }

  //set published date if there is one

  if($pub_date = _publication_date_get_date($node->nid)) {
    $pub_date = date('Y-m-d H:i:s',$pub_date);
  } else {
    $pub_date = '';
  }

  //Check for newsletter Exclude
  $newsletter = 0;
  if($field_exclude_newsletter = field_get_items('node', $node, 'field_newsletter_feed_exclude')) {
    $newsletter = $field_exclude_newsletter[0]['value'];
  }

  $json = '{
     "url":"'.url('node/'.$node->nid, array('absolute' => TRUE)).'",
     "title":"'.$node->title.'",
     "description":"'.$description.'",
     "publish_date":"'.$pub_date.'",
     "published":"'.$node->status.'",
     "tags":"'.$tags.'",
     "newsletter_exclude":"'.$newsletter.'",
     "image_url":{
        "full":{
           "url":"'.$image.'"
        },
        "thumb":{
           "url":"'.$thumb.'"
        }
     },
     "author":"'.$author.'",
     "access_token": "'.variable_get('content_services_access_token','').'"
  }';

  $endpoint = variable_get('takepart_api_domain', '').variable_get('content_services_endpoint','');

  //Make call to endpoint
  $ret = drupal_http_request($endpoint,
    array(
      'headers' => array('Content-Type' => 'application/json', 'Accept' => 'application/json'),
      'method' => 'POST',
      'data' => $json,
    )
  );

  //Check if return is valid log message
  $data = json_decode($ret->data);
  if($ret->code == 202 && isset($data->enqueued) && $data->enqueued) {
    watchdog('Content Notify Service',
      '%insup Node%nid %title of %type. Content Service was notified correctly. %data %json',
      array(
        '%insup' => $insup,
        '%nid' => $node->nid,
        '%title' => $node->title,
        '%type' => $node->type,
        '%data' => $ret->data,
        '%json' => $json
      ));
  } else {
    watchdog('Content Notify Service', '%insup Node%nid %title of %type. Content Service Failed to notify correctly. %data  %json',
      array(
        '%insup' => $insup,
        '%nid' => $node->nid,
        '%title' => $node->title,
        '%type' => $node->type,
        '%data' => $ret->data,
        '%json' => $json
      ),
      WATCHDOG_ERROR);
  }
}

/**
 * Content services get tags
 */
function _tp_content_services_get_tags($node) {
  $tags = '';
  $tag_array = array();

  //Do topic tags
  if($topic_tags = field_get_items('node', $node, 'field_topic')) {
    foreach ($topic_tags as $topic_tag) {
      if (isset($topic_tag['tid']) && is_numeric($topic_tag['tid'])) {
        $tax_obj = taxonomy_term_load($topic_tag['tid']);
        $topic_tag = $tax = $tax_obj->name;
        $topic_tag = str_replace(" & ", " ", $topic_tag);
        $topic_tag = str_replace(" ", "-", $topic_tag);
        $tag_array[] = strtolower($topic_tag);
      }
    }
  }

  //Do free tags
  if($free_tags = field_get_items('node', $node, 'field_free_tag')) {

    foreach ($free_tags as $free_tag) {
      if (isset($free_tag['tid']) && is_numeric($free_tag['tid'])) {
        $tax_obj = taxonomy_term_load($free_tag['tid']);
        $free_tag = $tax = $tax_obj->name;

        $free_tag = str_replace(" & ", " ", $free_tag);
        $free_tag = str_replace(" ", "-", $free_tag);
        $tag_array[] = strtolower($free_tag);
      }
    }
  }

  $tag_array[] = $node->type;
  $tags = implode(",", $tag_array);

  return $tags;
}

/**
 * Content services get authors
 */
function _tp_content_services_get_authors($node) {
  $author = '';
  if($field_authors = field_get_items('node', $node, 'field_author')){
    $author_ids = array();
    foreach ($field_authors as $field_author) {
      $author_ids[] = $field_author['nid'];
    }
    $author_nodes = entity_load('node', $author_ids);
    $authors = array();
    foreach($author_nodes as $author_node){
      $authors[] = $author_node->title;
    }
    $author = implode(",", $authors);
  }
  return $author;
}
