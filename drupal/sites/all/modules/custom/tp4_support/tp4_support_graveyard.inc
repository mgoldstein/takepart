<?php
/**
 * @file
 * TakePart dule for functions related to the Nov 2013 redesign
 * of TakePart and the TP4 Theme.
 */


function tp4_support_graveyard() {
  /* Query topics for the graveyard */
  $taxonomyQuery = new EntityFieldQuery();
  $taxonomyQuery->entityCondition('entity_type', 'taxonomy_term')
          ->propertyCondition('vid', '5')
          ->propertyOrderBy('weight')
          ->range(0,12);
  $topics = $taxonomyQuery->execute();

  $article_ids = array();
  $output = '';
  foreach($topics['taxonomy_term'] as $topic) {
    $topic_id = $topic->tid;
    $topic = taxonomy_term_load($topic_id);
    $output .= '<div class="topic">';
    $output .= '<div class="topic-title">'. l($topic->name, 'taxonomy/term/' . $topic_id) . '</div>';

    //TODO filter by nodes in an array generated by this foreach loop
    /* Query the latest article for the Topic */
    $articleQuery = new EntityFieldQuery();
    $articleQuery->entityCondition('entity_type', 'node')
            ->propertyCondition('type', array('openpublish_article', 'feature_article', 'flashcard'))
            ->propertyOrderBy('created', 'DESC')
            ->fieldCondition('field_topic', 'tid', $topic_id)
            ->range(0,1);
    $article = $articleQuery->execute();
    $article_id = current($article['node'])->nid;
    $article = node_load($article_id);

    foreach(field_get_items('node', $article, 'field_promo_headline') as $item) {
      $article_promo = drupal_render(field_view_value('node', $article, 'field_promo_headline', $item));
    }

    $article_promo = $article_promo ? $article_promo : $article->title;

		// Add Promoted tag
		$article_promo .= _tp4_support_sponsor_flag($article, true);

    $article_ids[] = $article->nid;
    $output .= '<div class="article-title">'. l($article_promo, 'node/'. $article->nid, array('html' => TRUE)) . '</div>';
    $output .= '</div>';
  }



  return theme('tp4_support_graveyard', array('output' => $output));

}









