<?php
/**
 * @file
 * TakePart dule for functions related to the Nov 2013 redesign
 * of TakePart and the TP4 Theme.
 */

/**
 * Implements hook_help().
 */
function tp4_support_help($path, $arg) {
	switch ($path) {
		case 'admin/help#tp4_support':
			return '<p>' . t('Support module for the TP4 theme and the Nov, 2013 redesign.') . '</p>';		
	}
}

/**
* Implements hook_entity_info_alter().
*
* Add view modes for homepage content display.
*/
function tp4_support_entity_info_alter(&$entity_info) {
  $entity_info['node']['view modes']['feature_main'] = array(
    'label' => t('Main Feature'),
    'custom settings' => TRUE,
  );
  $entity_info['node']['view modes']['feature_secondary'] = array(
    'label' => t('Secondary Feature'),
    'custom settings' => TRUE,
  );
  $entity_info['node']['view modes']['feature_topic'] = array(
    'label' => t('Topic Feature'),
    'custom settings' => TRUE,
  );
  $entity_info['node']['view modes']['feature_video'] = array(
    'label' => t('Video Feature'),
    'custom settings' => TRUE,
  );
}

/**
 * Hook Black Info
 */
function tp4_support_block_info(){
  $blocks = array();
  $blocks['tp4_footer'] = array(
    'info' => t('Footer for Homepage Redesign'),
  );
  $blocks['tp4_fat_header'] = array(
    'info' => t('Fat Header for the new TP4 theme'),
  );
  $blocks['tp4_dont_miss'] = array(
    'info' => t('Don\'t miss homepage promo'),
  );
  $blocks['tp4_graveyard'] = array(
    'info' => t('Graveyard'),
  );
  $blocks['tp4_slim_nav'] = array(
    'info' => t('Slim Nav'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view
 */
function tp4_support_block_view($delta = ''){
  $block = array();
  switch($delta){
    case 'tp4_footer':
      $block['content'] = tp4_support_footer();
    break;
    case 'tp4_fat_header':
      $block['content'] = tp4_support_fat_header();
    break;
    case 'tp4_dont_miss':
      $block['content'] = tp4_support_dont_miss();
    break;
    case 'tp4_graveyard':
      module_load_include('inc', 'tp4_support', 'tp4_support_graveyard');
      $block['content'] = tp4_support_graveyard();
    break;
    case 'tp4_slim_nav':
      $block['content'] = tp4_support_slim_nav();
    break;
  }
  return $block;
}
/**
 * Implements hook_block_configure
 */
function tp4_support_block_configure($delta = ''){
  $form = array();
  if ($delta == 'tp4_footer') {
    $form['tp4_support_footer_text'] = array(
      '#type' => 'textarea',
      '#title' => t('Footer Text'),
      '#description' => t('Text for the footer region'),
      '#default_value' => variable_get('tp4_support_footer_text', t('TakePart is the digital division of Participant Media')),
    );
  }
  if ($delta == 'tp4_dont_miss') {
    $form['tp4_support_dont_miss_label'] = array(
      '#type' => 'textfield',
      '#title' => t('Label'),
      '#description' => t('Label for the promo'),
      '#default_value' => variable_get('tp4_support_dont_miss_label', NULL),
    );
    $form['tp4_support_dont_miss_text'] = array(
      '#type' => 'textarea',
      '#title' => t('Promo'),
      '#description' => t('Text for the don\'t miss promo region'),
      '#default_value' => variable_get('tp4_support_dont_miss_text', NULL),
    );
    $form['tp4_support_dont_miss_link'] = array(
      '#type' => 'textfield',
      '#title' => t('Link'),
      '#description' => t('URL for the promo text'),
      '#default_value' => variable_get('tp4_support_dont_miss_link', NULL),
    );
    $form['tp4_support_dont_miss_link_target'] = array(
      '#type' => 'select',
      '#title' => t('Link Target'),
      '#options' => array(
          0 => t('_blank'),
          1 => t('_top'),
       ),
      '#description' => t('Target for the link'),
      '#default_value' => variable_get('tp4_support_dont_miss_link_target', 1),
    );
  }
  return $form;
}

/**
 * Implements hook_block_save
 */
function tp4_support_block_save($delta = '', $edit = array()) {
  if ($delta == 'tp4_footer') {
    variable_set('tp4_support_footer_text', $edit['tp4_support_footer_text']);
  }
  if ($delta == 'tp4_dont_miss') {
    variable_set('tp4_support_dont_miss_label', $edit['tp4_support_dont_miss_label']);
    variable_set('tp4_support_dont_miss_text', $edit['tp4_support_dont_miss_text']);
    variable_set('tp4_support_dont_miss_link', $edit['tp4_support_dont_miss_link']);
    variable_set('tp4_support_dont_miss_link_target', $edit['tp4_support_dont_miss_link_target']);
  }
}


/**
 * Implements hook_theme
 */
function tp4_support_theme() {
  return array(
    'tp4_support_footer' => array(
      'arguments' => array(),
      'variables' => array(
        'footer_text' => $footer_text,
      ),
      'template' => 'tp4-support-footer'
    ),
    'tp4_support_fat_header' => array(
      'arguments' => array(),
      'template' => 'tp4-support-fat-header',
      'variables' => array(
        'logo' => $logo,
        'user_links' => $user_links,
        'search' => $search,
        'megamenu' => $megamenu,
      ),
    ),
    'tp4_support_slim_nav' => array(
      'arguments' => array(),
      'template' => 'tp4-support-slim-nav',
      'variables' => array(
        'logo' => $logo,
        'user_links' => $user_links,
        'search' => $search,
        'megamenu' => $slimnav,
      ),
    ),
    'tp4_support_graveyard' => array(
      'arguments' => array(),
      'template' => 'tp4-support-graveyard',
    ),
    'tp4_author_full' => array(
      'template' => 'field-formatter--author-full',
      'variables' => array(
        'items' => array(),
        'entity' => '',
      )
    ),
    'tp4_promo_content' => array(
      'template' => 'field-formatter--promo-content',
      'variables' => array(
        'items' => array(),
        'entity' => '',
      )
    )
  );
}

function tp4_support_footer(){
  $footer_text = variable_get('tp4_support_footer_text', 'TakePart is the digital division of Participant Media');
  return theme('tp4_support_footer', array('footer_text' => $footer_text));
}
function tp4_support_fat_header(){
  global $base_url;
  global $user;
  $logo = $base_url. '/'. drupal_get_path('theme', 'tp4'). '/images/takepart_logo.png';
  if($user->uid == 0){
    $user_links = array();
    $user_links = array(
      '<li>'. l('Sign in', $base_url. '/user'). '</li>',
    );
  }
  else{
    $user_links = array(
      '<li class="user">'. l($user->name, $base_url. '/user'). '</li>',
      '<li>'. l('Sign out', $base_url. '/user/logout'). '</li>',
    );
    $search = drupal_render(drupal_get_form('search_block_form'));
  }
  $megamenu = module_invoke('tp_megamenu', 'block_view', 'tp_megamenu_megamenu');
  $megamenu = $megamenu['content'];

  return theme('tp4_support_fat_header', array('logo' => $logo, 'user_links' => $user_links, 'search' => $search, 'megamenu' => $megamenu));
}

function tp4_support_slim_nav(){
  global $base_url;
  global $user;
  drupal_add_css(drupal_get_path('module', 'tp4_support'). '/css/tp4_support.css', array());
  $logo = $base_url. '/'. drupal_get_path('theme', 'tp4'). '/images/takepart_logo.png';
  if($user->uid == 0){
    $user_links = array();
    $user_links = array(
      '<li>'. l('Sign in', $base_url. '/user'). '</li>',
    );
  }
  else{
    $user_links = array(
      '<li class="user">'. l($user->name, $base_url. '/user'). '</li>',
      '<li>'. l('Sign out', $base_url. '/user/logout'). '</li>',
    );
    $search = drupal_render(drupal_get_form('search_block_form'));
  }
  $slimnav = menu_tree_all_data('menu-megamenu', $link = NULL, $max_depth = 1);
  menu_tree_add_active_path($slimnav);
  $slimnav = drupal_render(menu_tree_output($slimnav));

  return theme('tp4_support_slim_nav', array('logo' => $logo, 'user_links' => $user_links, 'search' => $search, 'slimnav' => $slimnav));
}

function tp4_support_dont_miss(){
  $dont_miss_label = variable_get('tp4_support_dont_miss_label', NULL);
  $dont_miss_text = variable_get('tp4_support_dont_miss_text', NULL);
  $dont_miss_link = variable_get('tp4_support_dont_miss_link', NULL);
  $dont_miss_link_target = variable_get('tp4_support_dont_miss_link_target', 1);
  $output = '';
  if($dont_miss_text != NULL){
    $output .= '<div class="promo"><div class="inner">';
    if($dont_miss_label != NULL){
      $output .= '<label>'. $dont_miss_label. '</label>';
    }
    if($dont_miss_link == NULL){
      $output .= '<div class="text">'. $dont_miss_text. '</div>';
    }
    else{
      $target = ($dont_miss_link_target == 1 ? '_top' : '_blank');
      $output .= l($dont_miss_text, $dont_miss_link, array('html' => true, 'attributes' => array('class' => array ('text'), 'target' => $target)));
    }
    $output .= '</div></div>';
  }
  return $output;
}

/*
 * Implements hook_field_formatter_info()
 */
function tp4_support_field_formatter_info(){
  return array(
    'tp4_author_full' => array(
      'label' => t('Author w/ image and bio field formatter'),
      'field types' => array('node_reference'),
    ),
    'tp4_promo_content' => array(
      'label' => t('Promo Content'),
      'field types' => array('field_collection'),
    ),
  );
}

/*
 * Implements hook_field_formatter_view()
 */
function tp4_support_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display){
  $element = array();
  $settings = $display['settings'];
  switch($display['type']){
    case 'tp4_author_full':
      $element = array(
        '#theme' => 'tp4_author_full',
        '#items' => $items,
        '#entity' => $entity,
      );
    break;
    case 'tp4_promo_content':
      $element = array(
        '#theme' => 'tp4_promo_content',
        '#items' => $items,
        '#entity' => $entity,
      );
    break;
  }
  return $element;
}

function tp4_support_preprocess_block(&$variables) {
  if($variables['block_html_id'] == 'block-views-takeaction-homepage-block'){
    $variables['theme_hook_suggestions'][] = 'block__views__homepage_columns_block'; 
  }
}

function tp4_support_form_alter(&$form, &$form_state, $form_id){
  if($form['#form_id'] == 'search_api_page_search_form_site_search'){
    $form['keys_2']['#attributes']['placeholder'] = t('Search');
    $form['#action'] = '/';
  }

  $tab_title_override = variable_get('main_feature_tab_title_override', NULL);
  if($form['#form_id'] == 'ctools_node_content_type_edit_form'){
    dpm($form, 'form');
    $form['main_feature_tab_title_override'] = array(
      '#title' => t('TAB Title Override'),
      '#default_value' => t($tab_title_override),
      '#type' => 'textfield',
      '#description' => t('Override for the take action title'),
      '#states' => array(
        'visible' => array(
          ':input[name="build_mode"]' => array('value' => 'feature_main'),
        ),
      )
    );
    $form['#submit'][] = 'tp4_support_panel_main_feature';
  }
}


function tp4_support_panel_main_feature($form, &$form_state) {
  variable_set('main_feature_tab_title_override', $form['main_feature_tab_title_override']['#value']);
}
