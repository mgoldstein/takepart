<?php
/**
 * @file
 * The Blue State Digital User Management Module
 */

include_once dirname(__FILE__) . '/../../include/bsdapi/bsd.api.inc';

/**
 * Implements hook_help().
 */
function bluestatedigital_user_help($path, $arg) {
  $output = '';
  if ($path == 'admin/help#bluestatedigital_user') {
    $output .= '<h3>' . t('About') . '</h3>';
    $output .= '<p>' . t('The Blue State Digital module connects Drupal users
      with Blue State Digital constituents.') . '</p>';
    $output .= '<h3>' . t('Uses') . '</h3>';
    $output .= '<dl>';
    $output .= '<dt>' . t('Configure user management settings') . '</dt>';
    $output .= '<dd>' . t('To configure the user management settings visit the
      <a href="@api-config">User Management Configuration</a> page. On this page
      you can configure the information used to connect Drupal users with Blue
      State Digital constituents.',
      array(
        '@api-config' => url('admin/config/bluestatedigital/user'))) . '</dd>';
    $output .= '</dl>';
  }
  return $output;
}


/**
 * Implements hook_menu().
 */
function bluestatedigital_user_menu() {
  return array(
    'admin/config/bluestatedigital/user' => array(
      'title' => 'Blue State Digital User Management',
      'description' => 'Configure the signup form used to connect Drupal users to Blue State Digital constituents.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('bluestatedigital_user_admin_form'),
      'access callback' => 'user_access',
      'access arguments' => array('bluestatedigital configure api'),
    ),
  );
}

/**
 * Implements hook_user_insert().
 */
function bluestatedigital_user_user_insert(&$edit, $account, $category) {

  // Get the signup form and field used to add users to the welcome email list.
  $form_id = variable_get('bluestatedigital_user_welcome_email_form_id', 7);
  $field_id = variable_get('bluestatedigital_user_welcome_email_field_id', 80);

  // Build the email signup.
  $signup = array(
    $form_id => array(
      $field_id => array(
        'value' => array(
          'type' => 'value',
          'value' => $account->mail,
        ),
      ),
    ),
  );

  // Send the email signup.
  try {
    $api = bluestatedigital_get_api('signup');
    $api->processSignup($signup);
  }
  catch (BlueStateDigitalApiException $ex) {
    $message = 'Error sending email signup [@code] @body';
    watchdog('bluestatedigital_user', $message, array(
      '@code' => $ex->getResponseCode(),
      '@body' => $ex->getResponseBody(),
    ));
    return;
  }
}

/**
 * Admin form callback.
 */
function bluestatedigital_user_admin_form($form, &$form_state) {

  $defaults = array(
    'bluestatedigital_user_welcome_email_form_id' => 7,
    'bluestatedigital_user_welcome_email_field_id' => 80,
  );

  $values = array();
  foreach ($defaults as $name => $value) {
    if (isset($form_state['values'][$name])) {
      $values[$name] = $form_state['values'][$name];
    }
    else {
      $values[$name] = variable_get($name, $default[$name]);
    }
  }

  $form['welcome_email'] = array(
    '#type' => 'fieldset',
    '#title' => 'Welcome Email Signup',
    '#description' => t('The signup form for sending new users a weclome email.'),
    '#tree' => FALSE,
  );

  $form_id_field = bluestatedigital_forms_signup_form_id(
    $values['bluestatedigital_user_welcome_email_form_id']);
  $form_id_field += array(
    '#ajax' => array(
      'event' => 'change',
      'callback' => 'bluestatedigital_user_admin_form_callback',
      'wrapper' => 'bluestatedigital-user-email-field-wrapper',
      'progress' => array(
        'type' => 'throbber',
        'message' => t('Loading fields ...'),
      ),
    ),
  );
  $form['welcome_email']['bluestatedigital_user_welcome_email_form_id']
    = $form_id_field;

  $field_id_field = bluestatedigital_forms_signup_field_id(
    $values['bluestatedigital_user_welcome_email_form_id'],
    $values['bluestatedigital_user_welcome_email_field_id']);
  $field_id_field += array(
    '#prefix' => '<div id="bluestatedigital-user-email-field-wrapper">',
    '#suffix' => '</div>',
  );
  $form['welcome_email']['bluestatedigital_user_welcome_email_field_id']
    = $field_id_field;

  return system_settings_form($form);
}

/**
 * Admin form AJAX callback.
 */
function bluestatedigital_user_admin_form_callback($form, $form_state) {
  return $form['welcome_email']['bluestatedigital_user_welcome_email_field_id'];
}
