<?php
/**
 * @file
 * TakeAction Button Thank You Page Module.
 */

/**
 * Implements hook_block_info().
 */
function takeaction_thankyou_block_info() {
  return array(
    'thank-you' => array(
      'info' => 'Action Thank You Block',
      'cache' => DRUPAL_NO_CACHE,
    ),
    'dashboard' => array(
      'info' => 'Action Dashboard Block',
      'cache' => DRUPAL_NO_CACHE,
    ),
    'more-actions' => array(
      'info' => 'More Actions Block',
      'cache' => DRUPAL_NO_CACHE,
    ),
  );
}

function _takeaction_thankyou_term_list($node, $field) {
  // Extract the term ids.
  $tids = array();
  $items = field_get_items('node', $node, $field);
  if ($items !== FALSE) {
    foreach ($items as $delta => $item) {
      $tids[] = $item['tid'];
    }
  }
  // Load and implode the terms.
  $terms = taxonomy_term_load_multiple($tids);
  return taxonomy_implode_tags($terms);
}

/**
 * Helper function for getting the action context from the URL parameter.
 */
function takeaction_thankyou_get_action_context() {
  $context = FALSE;
  $signature_id = $_GET['action'];
  if (preg_match('/^[0-9]+$/', $signature_id)) {
    $signature = entity_load_single('signature', $signature_id);
    if ($signature !== FALSE) {
      $node = node_load($signature->nid);
      $signature_node = entity_load_single('signature_node', $node->nid);
      $uri = node_uri($node);
      $context = array(
        'node' => $node,
        'node_url' => url($uri['path'], array('absolute' => TRUE)),
        'email' => $signature->email,
        'newsletters' => (int) $signature->newsletter,
        'action_type' => signature_node_action_type_variables($node),
        'progress' => signature_node_progress_variables($signature_node),
        'thankyou' => array(
          'action_title' => check_plain($node->title),
          'action_url' => url($uri['path'], array('absolute' => TRUE)),
          'action_type' => _takeaction_thankyou_term_list($node, 'field_action_type'),
          'action_topic' => _takeaction_thankyou_term_list($node, 'field_display_tag'),
        ),
      );
    }
  }
  return $context;
}

/**
 * Implements hook_block_view().
 */
function takeaction_thankyou_block_view($delta = '') {
  $block = array();

  if ($delta === 'thank-you') {
    $block['subject'] = t('Thank you for taking action');
    $context = takeaction_thankyou_get_action_context();
    if ($context !== FALSE) {

      $node = $context['node'];
      $id = "takeaction-thankyou-share-bar-{$node->nid}";
      
      if ($node->type === 'petition_action' || $node->type === 'pledge_action') {
        $opt_ins = array();
        for ($num = 0, $check = 1; $num < 5; $num += 1, $check *= 2) {
          $opt_ins[$num] = ($context['newsletters'] & $check) ? TRUE : FALSE;
        }
        $analytics = tp_analytics_get_controller('node', $node->type);
        $events = $analytics->getSignedEvents($node, 'full', $opt_ins);
        foreach ($events as $event) {
          $analytics->addPageLoadEvent($event);
        }
        $analytics->addShareEventInstance($node, 'thank_you');
      }

      $block['content'] = array(
        '#type' => 'container',
        '#attributes' => array(
          'class' => array('takeaction-thankyou-message'),
        ),
        'message' => array(
          '#type' => 'container',
          '#attributes' => array(
            'class' => array('message'),
          ),
          'action_taken' => array(
            '#theme' => 'signature_action_taken',
            '#node' => $context['node'],
            '#action_type' => $context['action_type'],
            '#progress' => $context['progress'],
          ),
        ),
        'progress' => array(
          '#type' => 'container',
          '#attributes' => array(
            'class' => array('progress'),
          ),
          'progress_percent' => array(
            '#theme' => 'signature_progress_percent',
            '#node' => $context['node'],
            '#action_type' => $context['action_type'],
            '#progress' => $context['progress'],
          ),
          'progress_goal' => array(
            '#theme' => 'signature_progress_goal',
            '#node' => $context['node'],
            '#action_type' => $context['action_type'],
            '#progress' => $context['progress'],
          ),
        ),
        'social-share' => array(
          '#type' => 'container',
          '#attributes' => array(
            'class' => array('sharing'),
          ),
          'share_heading' => array(
            '#theme' => 'html_tag',
            '#tag' => 'h3',
            '#attributes' => array(
              'class' => array(
                'share-heading',
              ),
            ),
            '#value' => t('Spread The Word'),
          ),
          'share_bar' => theme(
            'takepart_addthis_takeaction_thank_you_button_bar', array(
            'orientation' => 'share-bar-horizontal',
            'id' => "takeaction-thankyou-share-bar-{$node->nid}",
            'share_url' => $context['node_url'],
            'nid' => $node->nid,
          )),
        ),
      );

      $configurations = array();
      $items = field_get_items('node', $node, 'field_thank_you_share_bar');
      if (!empty($items)) {
        $item = reset($items);
        $configurations[$id] = array(
          'alternate_url' => empty($item['alternate_url'])
            ? $context['node_url'] : $item['alternate_url'],
          'twitter_message' => $item['twitter_message'],
          'email_message' => $item['email_message'],
        );
      }
    
      drupal_add_js(drupal_get_path('module', 'takepart_addthis')
        . '/js/share-bar-field.js',
        array('type' => 'file')
      );

      drupal_add_js(array(
        'takeaction' => array(
          'thankyou' => $context['thankyou'],
        ),
        'addthis' => array(
          'email' => $context['email'],
          'fields' => $configurations,
        ),
      ), 'setting');
    }
    else {
      $block['content'] = '';
    }
  }
  elseif ($delta === 'dashboard') {
    global $user;
    $dashboard_url = variable_get('takeaction_dashboard_url', '');
    $variables = array(
      'logged_in' => !empty($user->uid),
      'heading' => t('Track Your Impact'),
      'text' => variable_get('takeaction_dashboard_description', ''),
      'dashboard_link' => t('>> View Your Dashboard'),
      'dashboard_url' => $dashboard_url,
      'login_link' => t('Continue with Facebook Login'),
      'login_url' => '/user?' . drupal_http_build_query(array(
          'destination' => $dashboard_url,
      )),
    );
    $block['subject'] = t('Track your impact');
    $block['content'] = theme('takeaction_thankyou_dashboard_block', $variables);
  }
  elseif ($delta === 'more-actions') {
    $block['subject'] = t('View more actions that need support');
    $block['content'] = '';
    $context = takeaction_thankyou_get_action_context();
    if ($context !== FALSE) {
      $more_actions_url = variable_get('takeaction_more_actions_url', '');
      if (!empty($more_actions_url)) {
        $src = url($more_actions_url, array(
          'query' => array(
            'action_id' => $context['node']->nid,
          ),
        ));
        $block['content'] = array(
          '#theme' => 'html_tag',
          '#tag' => 'iframe',
          '#attributes' => array(
            'src' => $src,
            'class' => implode(' ', array('more-actions')),
            'frameborder' => 0,
          ),
          '#value' => '',
        );
      }
    }
  }
  return $block;
}

/**
 * Implements hook_theme().
 */
function takeaction_thankyou_theme() {
  return array(
    'takeaction_thankyou_dashboard_block' => array(
      'variables' => array(
        'logged_in' => NULL,
      ),
      'template' => 'theme/dashboard-block',
    ),
    'takeaction_thankyou_more_actions_block' => array(
      'variables' => array(
        'action_id' => NULL,
      ),
      'template' => 'theme/more-action-block',
    ),
  );
}
