<?php
/**
 * @file
 * TakeAction Button Action Feed Module.
 */

/**
 * Implements hook_help().
 */
function takeaction_feed_help($path, $arg) {
  $output = '';
  if ($path == 'admin/help#takeaction_feed') {
    $output .= '<h3>' . t('About') . '</h3>';
    $output .= '<p>' . t('The TakeAction Button Feed module provides a JSON feed
      of action items on the TakePart site for consumption by the TakeAction
      Button system.') . '</p>';
  }
  return $output;
}

/**
 * Implements hook_menu().
 */
function takeaction_feed_menu() {
  return array(
    'takeaction/feeds/actions' => array(
      'page callback' => 'takeaction_feed_actions_callback',
      'type' => MENU_CALLBACK,
      'access arguments' => array('access content'),
    ),
    'admin/config/takeaction/feeds' => array(
      'title' => 'TakeAction Button Feed Settings',
      'description' => 'Settings for TakeAction Button feeds',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('takeaction_feed_admin_form'),
      'access callback' => 'user_access',
      'access arguments' => array('takeaction configure settings'),
    ),
  );
}

/**
 * Actions feed callback.
 */
function takeaction_feed_actions_callback() {
  $query = db_select('takeaction_feed_actions', 'a')
    ->fields('a', array('nid', 'data'));
  if (variable_get('takeaction_feed_filter_unpublished', 1)) {
    $query = $query->condition('a.published', 0, '!=');
  }
  if (variable_get('takeaction_feed_filter_takepart_only', 1)) {
    $query = $query->condition('a.takepart_only', 0, '=');
  }
  $actions = $query->execute();
  $items = array();
  while ($action = $actions->fetchAssoc()) {
    $items[] = unserialize($action['data']);
  }
  return drupal_json_output($items);
}

/**
 * Admin form callback.
 */
function takeaction_feed_admin_form($form, &$form_state) {

  $form['takeaction_feed_content_domain'] = array(
    '#type' => 'textfield',
    '#title' => t('Content domain'),
    '#description' => t('The domain to use in all action URLs'),
    '#default_value' => variable_get('takeaction_feed_content_domain', ''),
    '#required' => TRUE,
  );

  $form['takeaction_feed_filter_unpublished'] = array(
    '#type' => 'checkbox',
    '#title' => t('Exclude unpublished actions'),
    '#description' => t('Exclude unpublished actions from the actions feed'),
    '#default_value' => variable_get('takeaction_feed_filter_unpublished', 1),
  );

  $form['takeaction_feed_filter_takepart_only'] = array(
    '#type' => 'checkbox',
    '#title' => t('Exclude TakePart.com only actions'),
    '#description' => t('Exclude actions that are not marked as TAB actions from the actions feed'),
    '#default_value' => variable_get('takeaction_feed_filter_takepart_only', 1),
  );

  $form['actions']['takeaction_feed_rebuild_actions'] = array(
    '#type' => 'submit',
    '#value' => t('Rebuild Actions Feed'),
    '#submit' => array('takeaction_feed_admin_form_submit_rebuild'),
  );

  return system_settings_form($form);
}

/**
 * Admin form rebuild feed submit callback.
 */
function takeaction_feed_admin_form_submit_rebuild($form, $form_state) {
  $counts = array(
    'action' => 0,
    'petition_action' => 0,
    'pledge_action' => 0,
  );
  db_delete('takeaction_feed_actions');
  $nodes = db_select('node', 'n')
    ->fields('n', array('nid', 'type'))
    ->condition('n.type', array_keys($counts), 'IN')
    ->execute()
    ->fetchAllKeyed();
  foreach ($nodes as $nid => $type) {
    $node = node_load($nid);
    takeaction_feed_entity_update($node, 'node');
    $counts[$type] += 1;
  }
  $message = t('!total action items rebuilt', array(
    '!total' => array_sum($counts),
  ));
  drupal_set_message($message);
}

/**
 * Implements hook_entity_insert().
 */
function takeaction_feed_entity_insert($entity, $type) {
  takeaction_feed_entity_update($entity, $type);
}

/**
 * Implements hook_entity_update().
 */
function takeaction_feed_entity_update($entity, $type) {

  $data = FALSE;
  if ($type === 'followup') {
    $node = node_load($entity->nid);
    if ($node !== FALSE) {
      $data = takeaction_feed_action_item_data($node);
    }
  }
  elseif ($type === 'node') {
    $node = $entity;
    $data = takeaction_feed_action_item_data($entity);
  }
  else {
    return;
  }

  if ($data !== FALSE) {
    $timestamp = time();
    $tab_action = _takeaction_feed_field_value($node, 'field_tab_action', '0');
    db_merge('takeaction_feed_actions')
      ->key(array(
        'nid' => $node->nid,
      ))
      ->insertFields(array(
        'nid' => $node->nid,
        'created' => $timestamp,
        'changed' => $timestamp,
        'published' => $node->status,
        'takepart_only' => empty($tab_action) ? 1 : 0,
        'data' => serialize($data),
      ))
      ->updateFields(array(
        'changed' => $timestamp,
        'published' => $node->status,
        'takepart_only' => empty($tab_action) ? 1 : 0,
        'data' => serialize($data),
      ))
      ->execute();
  }
  else {
    db_delete('takeaction_feed_actions')
      ->condition('nid', $node->nid, '=')
      ->execute();
  }
}

/**
 * Implements hook_entity_delete().
 */
function takeaction_feed_entity_delete($entity, $type) {
  if ($type === 'followup') {
    // Update the action item for the followup's node.
    $node = node_load($entity->nid);
    if ($node !== FALSE) {
      takeaction_feed_entity_update('node', $node);
    }
  }
  elseif ($type === 'node') {
    // Delete the action item for the node.
    db_delete('takeaction_feed_actions')
      ->condition('nid', $$entity->nid, '=')
      ->execute();
  }
}

/**
 * Helper function for getting the first value of a field.
 *
 * @param string $entity_type
 *   The type of entity.
 * @param object $entity
 *   The entity to which the field is attached.
 * @param string $field
 *   The name of the field.
 */
function _takeaction_feed_field_get_item($entity_type, $entity, $field) {
  $items = field_get_items($entity_type, $entity, $field);
  if ($items !== FALSE) {
    return reset($items);
  }
  return FALSE;
}

/**
 * Helper function for translating a field with a 'value' into a single string.
 *
 * @param object $node
 *   The node to which the field is attached.
 * @param string $field
 *   The name of the field containing the value.
 * @param string $default
 *   The default value to return if the field has not been set on the action.
 *
 * @return string
 *   The text of the field stripped of all HTML markup.
 */
function _takeaction_feed_field_value($node, $field, $default = '') {
  $items = field_get_items('node', $node, $field);
  if ($items !== FALSE) {
    $first = reset($items);
    return strip_tags($first['value']);
  }
  return $default;
}

/**
 * Helper function for translating the update text into a list of values.
 *
 * @param object $node
 *   The node to which the updates are connected.
 *
 * @return array
 *   An array of the update text values stripped of all HTML markup.
 */
function _takeaction_feed_update_text_list($node, &$last_updated) {

  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'followup')
    ->propertyCondition('type', 'content_link')
    ->propertyCondition('nid', $node->nid)
    ->execute();

  $values = array();
  if (!empty($result['followup'])) {
    $updates = entity_load('followup', array_keys($result['followup']));
    foreach ($updates as $id => $update) {

      if ($update->changed > $last_updated) {
        $last_updated = $update->changed;
      }

      $text_item = _takeaction_feed_field_get_item('followup', $update,
        'field_tab_update_text');
      $link_items = field_get_items('followup', $update,
        'field_tab_content_link');
      $timestamp_item = _takeaction_feed_field_get_item('followup', $update,
        'field_tab_update_timestamp');

      if ($timestamp_item !== FALSE) {
        $value = array(
          'title' => $update->title,
          'timestamp' => $timestamp_item['value'],
        );
        if ($text_item !== FALSE) {
          $value['text'] = strip_tags($text_item['value']);
        }
        if ($link_items !== FALSE) {
          $value['contentLinks'] = array();
          foreach ($link_items as $delta => $link_item) {
            $value['contentLinks'][] = array(
              'title' => $link_item['title'],
              'url' => $link_item['url'],
            );
          }
        }
        $values[] = $value;
      }
    }
  }
  return $values;
}

/**
 * Helper function for translating a group reference field.
 *
 * @param object $node
 *   The node to which the field is attached.
 * @param string $field
 *   The name of the field containing the group reference.
 *
 * @return array
 *   An associative array containing the following
 *   title - The title of the group.
 *   description - A description of the group.
 *   thumbnail - The absolute URL to the group thumbnail image.
 */
function _takeaction_feed_group_list($node, $field) {
  $items = field_get_items('node', $node, $field);
  $groups = array();
  if ($items !== FALSE) {
    foreach ($items as $delta => $item) {
      $groups[] = array(
        'title' => $item['title'],
        'description' => '',
        'thumbnail' => '',
      );
    }
  }
  return $groups;
}

/**
 * Helper function for translating the content links into a list of links.
 *
 * @param object $node
 *   The node to which the content links are attached.
 *
 * @return array
 *   An associative array containing the following
 *   title - The title of the link.
 *   url - The absolute URL of the link.
 */
function _takeaction_feed_content_link_list($node) {

  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'followup')
    ->propertyCondition('type', 'content_link')
    ->propertyCondition('nid', $node->nid)
    ->execute();

  $links = array();
  if (!empty($result['followup'])) {

    $updates = entity_load('followup', array_keys($result['followup']));
    foreach ($updates as $id => $update) {

      $link_item = _takeaction_feed_field_get_item('followup', $update,
        'field_tab_content_link');
      $timestamp_item = _takeaction_feed_field_get_item('followup', $update,
        'field_tab_update_timestamp');

      if ($link_item !== FALSE && $timestamp_item !== FALSE) {
        $links[] = array(
          'title' => $link_item['title'],
          'url' => $link_item['url'],
          'timestamp' => $timestamp_item['value'],
        );
      }
    }
  }
  return $links;
}

function _takeaction_feed_build_url($pieces) {
  $url = '';
  if ($pieces['scheme']) {
    $url = $pieces['scheme'] . ':';
  }
  $url .= '//';
  if (isset($pieces['user'])) {
    $url .= $pieces['user'];
    if (isset($pieces['pass'])) {
      $url .= ':' . $pieces['pass'];
    }
    $url .= '@';
  }
  if (isset($pieces['host'])) {
    $url .= $pieces['host'];
  }
  if (isset($pieces['path'])) {
    $url .= $pieces['path'];
  }
  if (isset($pieces['query'])) {
    $url .= '?' . $pieces['query'];
  }
  if (isset($pieces['fragment'])) {
    $url .= '#' . $pieces['fragment'];
  }
  return $url;
}

/**
 * Rebuild a URL for the configurable TakePart content domain.
 */
function _takeaction_feed_update_domain($url, $force = FALSE) {
  $new_domain = variable_get('takeaction_feed_content_domain', NULL);
  if (!empty($new_domain)) {
    $pieces = parse_url($url);
    $is_domain = strpos($pieces['host'], '.');
    $is_takepart = substr_compare($pieces['host'], 'takepart.com', -12, 12);
    if ($force || $is_domain === FALSE || $is_takepart === 0) {
      $pieces['host'] = $new_domain;
      $url = _takeaction_feed_build_url($pieces);
    }
  }
  return $url;
}

/**
 * Helper function for translating a media asset field to a URL.
 *
 * @param object $node
 *   The node to which the field is attached.
 * @param string $field
 *   The name of the field containing the terms.
 *
 * @returns string
 *   The absolute URL of the media asset.
 */
function _takeaction_feed_media_url($node, $field) {
  $items = field_get_items('node', $node, $field);
  if ($items !== FALSE) {
    $first = reset($items);
    $file = file_load($first['fid']);
    $url = file_create_url($file->uri);
    return _takeaction_feed_update_domain($url);
  }
  return '';
}

/**
 * Helper function for translating a term reference field.
 *
 * @param object $node
 *   The node to which the field is attached.
 * @param string $field
 *   The name of the field containing the terms.
 *
 * @returns string
 *   The terms in the field as a comma separated list of values.
 */
function _takeaction_feed_term_list($node, $field) {
  // Extract the term ids.
  $tids = array();
  $items = field_get_items('node', $node, $field);
  if ($items !== FALSE) {
    foreach ($items as $delta => $item) {
      $tids[] = $item['tid'];
    }
  }
  // Load and implode the terms.
  $terms = taxonomy_term_load_multiple($tids);
  return taxonomy_implode_tags($terms);
}

/**
 * Helper function for translating the action page URL.
 *
 * @param object $node
 *   The action node.
 *
 * @return string
 *   The URL of the action page.
 */
function _takeaction_feed_page_url($node) {
  $page_url = url('node/' . $node->nid, array('absolute' => TRUE));
  if ($node->type == 'action') {
    $tab_action = _takeaction_feed_field_get_item('node', $node, 'field_tab_action');
    $link_only = _takeaction_feed_field_get_item('node', $node, 'field_tab_link_only');
    $action = _takeaction_feed_field_get_item('node', $node, 'field_action_url');
    if ($tab_action !== FALSE && $link_only !== FALSE && $action !== FALSE) {
      if ($tab_action['value'] && $link_only['value']) {
        $page_url = $action['url'];
      }
    }
  }
  return _takeaction_feed_update_domain($page_url);
}

/**
 * Function for creating an action feed item data set.
 */
function takeaction_feed_action_item_data($node) {
  $action_types = array(
    'action',
    'petition_action',
    'pledge_action',
  );
  if (in_array($node->type, $action_types)) {

    // Get the internal title.
    $internal_title = _takeaction_feed_field_value($node,
      'field_tab_internal_title');
    if (strlen(trim($internal_title)) === 0) {
      // Use the promo headline instead.
      $internal_title = _takeaction_feed_field_value($node,
        'field_promo_headline');
      if (strlen(trim($internal_title)) === 0) {
        // Use the internal Drupal title instead.
        $internal_title = empty($node->title) ? '' : $node->title;
      }
    }

    // Get the external title.
    $external_title = _takeaction_feed_field_value($node,
      'field_tab_external_title');
    if (strlen(trim($external_title)) === 0) {
      // Use the internal title instead.
      $external_title = $internal_title;
    }

    $thumbnail_url = _takeaction_feed_media_url($node,
      'field_action_main_image');
    if (strlen(trim($thumbnail_url)) === 0) {
      // Use the promo thumbnail instead.
      $thumbnail_url = _takeaction_feed_media_url($node,
        'field_thumbnail');
    }

    // The actionCopy value is an aggregate of the fields that make up the
    // 'body' of the action.
    if ($node->type === 'pledge_action') {
      // For pledges uses the issue field, what you can do field and the
      // pledge statement (body) field.
      $aggregate_body = _takeaction_feed_field_value($node,
        'field_pledge_issue');
      $aggregate_body .= _takeaction_feed_field_value($node,
        'field_pledge_action_long');
      $aggregate_body .= _takeaction_feed_field_value($node, 'body');
    }
    elseif ($node->type === 'petition_action') {
      // For petitions use the short introduction (body) field and the about
      // the petition field.
      $aggregate_body = _takeaction_feed_field_value($node, 'body');
      $aggregate_body .= _takeaction_feed_field_value($node,
        'field_petition_about');
    }
    else {
      // For simple actions use the body field.
      $aggregate_body = _takeaction_feed_field_value($node, 'body');
    }

    // Get the action goal and date range (if available). Also get the action
    // button text to use as a default if the TAB call to action field is
    // empty.
    if ($node->type === 'pledge_action' || $node->type === 'petition_action') {
      // For petitions and pledges the fields are stored in the signature
      // settings.
      $settings = entity_load_single('signature_node', $node->nid);
      $button_text = $settings->sign_label;
      $action_goal = $settings->goal;
      if ($settings->limit_to_dates) {
        $date_range = array(
          'limited' => 'true',
          'startDate' => $settings->start_date,
          'endDate' => $settings->end_date,
        );
      }
      else {
        $date_range = array(
          'limited' => 'false',
          'startDate' => 0,
          'endDate' => 0,
        );
      }
    }
    else {
      // For simple actions use empty defaults.
      $button_text = '';
      $action_goal = 0;
      $date_range = array(
        'limited' => 'false',
        'startDate' => 0,
        'endDate' => 0,
      );
    }

    // Get the optional call to action, use the signature button text as a
    // default if the call to action is empty.
    $call_to_action = _takeaction_feed_field_value($node,
      'field_tab_call_to_action');
    if (strlen(trim($external_title)) === 0) {
      $call_to_action = $button_text;
    }

    $last_updated = $node->changed;
    $update_text = _takeaction_feed_update_text_list($node, $last_updated);

    return array(
      'id' => $node->nid,
      'TABAction' => _takeaction_feed_field_value($node, 'field_tab_action',
        '0'),
      'exclude' => _takeaction_feed_field_value($node, 'field_tab_exclude',
        '0'),
      'internalTitle' => $internal_title,
      'externalTitle' => $external_title,
      'publishedDate' => $node->created,
      'updatedDate' => $last_updated,
      'internalDescription' => _takeaction_feed_field_value($node,
        'field_tab_internal_desc'),
      'externalDescription' => _takeaction_feed_field_value($node,
        'field_tab_external_desc'),
      'callToAction' => $call_to_action,
      'pageUrl' => _takeaction_feed_page_url($node),
      'thumbnailUrl' => $thumbnail_url,
      'type' => _takeaction_feed_term_list($node, 'field_action_type'),
      'sponsors' => _takeaction_feed_group_list($node,
        'field_action_sponsors'),
      'organizations' => _takeaction_feed_group_list($node,
        'field_action_organization'),
      'topic' => _takeaction_feed_term_list($node, 'field_topic'),
      'freeTag' => _takeaction_feed_term_list($node, 'field_free_tag'),
      'actionCopy' => $aggregate_body,
      'updateText' => $update_text,
      'actionGoal' => $action_goal,
      'dateRange' => $date_range,
      'priority' => _takeaction_feed_field_value($node, 'field_priority'),
    );
  }
  return FALSE;
}
