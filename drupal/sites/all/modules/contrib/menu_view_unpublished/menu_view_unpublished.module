<?php

/**
 * Implements hook_permission().
 */
function menu_view_unpublished_permission() {
  return array(
    'menu view unpublished' => array(
      'title' => t('View menu links to unpublished but accessible content'),
    ),
  );
}

/**
 * Implements hook_query_TAG_alter().
 *
 * @see menu_tree_check_access()
 *   Contains the query being altered here. This is most likely the only query
 *   with tag node_access where the first condition is for the node.status column.
 */
function menu_view_unpublished_query_node_access_alter(QueryAlterableInterface $query) {
  if (user_access('menu view unpublished')) {
    $conditions = &$query->conditions();
    // Remove the status condition if we suspect this query originates from.
    if (count($conditions) > 1 && is_string($conditions[0]['field']) && $conditions[0]['field'] == 'n.status') {
      unset($conditions[0]);
    }
  }
}

/**
 * Implements hook_menu_link_alter().
 */
function menu_view_unpublished_menu_link_alter(&$item) {
  // Add a class to menu links that link to unpublished nodes.
  if (preg_match('@^node/(\d+)$@', $item['link_path'], $matches)) {
    $node = node_load((int) $matches[1]);
    if ($node && $node->status == NODE_NOT_PUBLISHED) {
      $item['options']['attributes']['class'] = 'menu-node-unpublished';
    }
  }
}