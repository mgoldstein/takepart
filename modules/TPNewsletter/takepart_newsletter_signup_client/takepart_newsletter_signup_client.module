<?php

require_once ( dirname(__FILE__) . '/takepart_newsletter_signup_client.forms.inc');


/**
 * Implementation of hook_theme()
 */
function takepart_newsletter_signup_client_theme() {
  return array(
    'newsletter_signup_block' => array(
      'arguments' => array('form_id' => NULL, 'promo_text' => NULL, 'signup_form' => NULL),
      'template' => 'newsletter-signup-block',
    ),
  );
}


/**
 * Implementation of hook_perms()
 */
function takepart_newsletter_signup_client_perm() {
  return array('administer newsletter email collector client');
}


/**
 * Implementation of hook_menu()
 */
function takepart_newsletter_signup_client_menu() {

  $items = array();

  $items['newsletter-campaign/submit-campaign'] = array(
    'title' => t('Newsletter Form Submission'),
    'access arguments' => array('access content'),
    'page callback' => 'takepart_newsletter_signup_client_newsletter_signup_form_submit_from_ajax',
  );
  
   $items['admin/settings/takepart-newsletter-signup-client'] = array(
    'type' => MENU_NORMAL_ITEM,
	'title' => t('TakePart Newsletter Signup client'),
	'description' => t('Settings for newsletter signup client'),
	'page callback' => 'drupal_get_form',
	'page arguments' => array('takepart_newsletter_signup_client_admin_settings'),
	'access arguments' => array('administer newsletter email collector client'),
  );
  
  return $items; 
}

/**
 * Implementation of hook_block()
 */
function takepart_newsletter_signup_client_block($op = 'list', $delta = 0, $edit = array())
{ 
   if ($op == "list") {
	$blocks = array();
    $campaigns = takepart_newsletter_signup_client_get_active_campaigns();
    
    if (!empty($campaigns)) {
      foreach($campaigns as $campaign) {
        $blocks[$campaign->nid] = array(
          'info' => t($campaign->title),
        );
      }
    }
    
    return $blocks;
  }
  else if ($op == 'view') {   
    return _takepart_newsletter_signup_client_block_view($delta);
  }
}



/**
 * return html to display in block; called from $op = view in hook_block
 */
function _takepart_newsletter_signup_client_block_view($delta) {
  $path = drupal_get_path('module', 'takepart_newsletter_signup_client');
  drupal_add_js($path .'/takepart_newsletter_signup.js', 'module');
  drupal_add_css($path .'/takepart_newsletter_signup.css');

  $content = '';
  
  if (is_numeric($delta)) {
    $node = node_load($delta);

    $content = theme(
      'newsletter_signup_block',
      $node->field_newsletter_campaign_id[0]['value'],
      $node->field_newsletter_promo_text[0]['value'],
      drupal_get_form('takepart_newsletter_signup_client_newsletter_signup_form', $node->field_newsletter_campaign_id[0]['value'])
    );
  }
  
  $block = array();
  $block['content'] = $content;
  $block['subject'] = $node->field_newsletter_header[0]['value'];
  
  return $block;
}



/**
 *  Return a list of campaign nodes (nid and titles)
 *
 *  @return array - contains object with nid and title properties
 */
function takepart_newsletter_signup_client_get_active_campaigns() {
  $campaigns = array();
  
  $results = db_query("SELECT title, nid FROM {node} WHERE type = 'newsletter_campaign' AND status = 1 ORDER BY title");
  
  while($result = db_fetch_object($results)) {
    $campaigns[] = $result;
  }
  
  return $campaigns;
}


/**
 *  Look up the campaign node id based on pluris campaign id
 *
 *  @param $campaign_id string - campaign id from pluris
 *
 *  @return int - node id from drupal node
 */
function takepart_newsletter_signup_client_get_campaign_nid($campaign_id) {
  return db_result(db_query("SELECT n.nid FROM {node} n INNER JOIN {content_type_newsletter_campaign} c ON n.vid = c.vid WHERE c.field_newsletter_campaign_id_value = '%s'", $campaign_id));
}

